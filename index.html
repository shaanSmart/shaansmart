<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="ShaanSmart">
<meta name="theme-color" content="#2a5fa8">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icons/icon-192.png">
<title>ShaanSmart</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;800;900&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
:root{
  --bg:#eef1fb;--muted:#8890aa;
  --blue-bg:#ddeeff;--blue-mid:#5b9bd5;--blue-txt:#1a3d70;
  --green-bg:#d4f5e2;--green-mid:#3db87a;--green-deep:#1a7a4a;--green-txt:#0d4a2a;
  --purple-bg:#ece5ff;--purple-mid:#9b7fd4;--purple-txt:#32196e;
  --red-bg:#ffe5e5;--red-mid:#e85555;--red-deep:#a81a1a;--red-txt:#6e0d0d;
}
html,body{height:100%;overflow:hidden;font-family:'Nunito',sans-serif;color:#1a1a2e;user-select:none;-webkit-user-select:none;}

/* SCREENS â€” each locks to full viewport */
.screen{position:fixed;top:0;left:0;right:0;bottom:0;display:none;flex-direction:column;overflow:hidden;background:var(--bg);}
.screen.active{display:flex;}

/* HOME */
#home{background:linear-gradient(160deg,#1e3a7a,#2a5fa8,#4a8fd8);overflow-y:auto;align-items:center;padding:env(safe-area-inset-top,16px) 20px env(safe-area-inset-bottom,16px);gap:0;}
.home-logo{font-size:3.5rem;margin-top:12px;animation:float 3s ease-in-out infinite;}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
.home-title{font-size:clamp(1.8rem,7vw,2.8rem);font-weight:900;color:white;margin-top:4px;}
.home-sub{font-size:.9rem;color:rgba(255,255,255,.7);font-weight:700;margin-top:2px;margin-bottom:14px;}
.stars-strip{background:rgba(255,255,255,.15);border-radius:40px;padding:7px 20px;color:white;font-weight:900;font-size:.9rem;margin-bottom:14px;display:flex;align-items:center;gap:8px;}
.sec-lbl{color:rgba(255,255,255,.7);font-size:.7rem;font-weight:800;text-transform:uppercase;letter-spacing:1px;align-self:flex-start;margin-bottom:6px;}
.grade-row{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px;align-self:flex-start;}
.grade-btn{background:rgba(255,255,255,.18);border:2px solid rgba(255,255,255,.35);border-radius:40px;padding:6px 16px;font-family:'Nunito',sans-serif;font-size:.8rem;font-weight:800;cursor:pointer;color:white;transition:all .15s;}
.grade-btn.active{background:white;color:#2a5fa8;border-color:white;}
.subject-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;width:100%;max-width:500px;margin-bottom:14px;}
.subject-card{border-radius:18px;padding:18px 12px 14px;display:flex;flex-direction:column;align-items:center;gap:5px;cursor:pointer;transition:transform .15s;box-shadow:0 6px 20px rgba(0,0,0,.2);border:2px solid rgba(255,255,255,.2);position:relative;}
.subject-card:active{transform:scale(.96);}
.subject-card.math{background:linear-gradient(135deg,#2a5fa8,#5b9bd5);}
.subject-card.read{background:linear-gradient(135deg,#1a7a4a,#3db87a);}
.subject-card.life{background:linear-gradient(135deg,#a84a10,#f07a3a);}
.subject-card.sci{background:linear-gradient(135deg,#5c3db8,#9b7fd4);}
.s-badge{position:absolute;top:8px;right:10px;background:rgba(255,255,255,.25);border-radius:20px;padding:2px 8px;font-size:.6rem;font-weight:900;color:white;}
.s-icon{font-size:2rem;}.s-name{font-size:.88rem;font-weight:900;color:white;}.s-count{font-size:.63rem;color:rgba(255,255,255,.75);font-weight:700;}
.nav-bar{display:flex;background:white;box-shadow:0 -2px 10px rgba(0,0,0,.08);flex-shrink:0;width:100%;padding-bottom:env(safe-area-inset-bottom,0px);}
.nav-item{flex:1;display:flex;flex-direction:column;align-items:center;padding:10px 4px 8px;cursor:pointer;border:none;background:none;font-family:'Nunito',sans-serif;gap:2px;}
.nav-icon{font-size:1.3rem;}.nav-label{font-size:.65rem;font-weight:800;color:var(--muted);}
.nav-item.active .nav-label{color:#2a5fa8;}

/* QUIZ â€” strict column layout */
#quiz{background:var(--bg);}
.quiz-hdr{display:flex;align-items:center;gap:12px;padding:env(safe-area-inset-top,10px) 16px 10px;background:white;box-shadow:0 2px 8px rgba(0,0,0,.07);flex-shrink:0;}
.back-btn{background:none;border:none;font-size:1.4rem;cursor:pointer;padding:4px 8px;border-radius:8px;}
.quiz-subj{font-size:1rem;font-weight:900;}
.quiz-stars{margin-left:auto;font-size:.88rem;font-weight:800;color:#9a6e00;background:#fff9e0;border-radius:30px;padding:4px 12px;}
.prog-wrap{padding:6px 16px 4px;flex-shrink:0;}
.prog-lbl{font-size:.68rem;font-weight:800;color:var(--muted);margin-bottom:3px;}
.prog-bg{background:#dde3f5;border-radius:40px;height:8px;overflow:hidden;}
.prog-fill{height:100%;border-radius:40px;transition:width .5s ease;background:#5b9bd5;}

/* Question card â€” no scroll, shrinks to content */
.q-box{margin:8px 14px 0;background:white;border-radius:18px;box-shadow:0 3px 12px rgba(0,0,0,.07);padding:12px 18px;text-align:center;flex-shrink:0;animation:fadeUp .25s ease;}
@keyframes fadeUp{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.q-badge{display:inline-block;border-radius:40px;padding:2px 10px;font-size:.6rem;font-weight:900;text-transform:uppercase;letter-spacing:1px;margin-bottom:4px;}
.q-img{font-size:2.2rem;margin-bottom:2px;}
.q-text{font-size:clamp(2.2rem,8vw,4rem);font-weight:900;line-height:1.2;}

/* Feedback â€” hidden until answered */
.feedback{margin:5px 14px 0;border-radius:12px;padding:7px 14px;font-size:.88rem;font-weight:800;text-align:center;display:flex;flex-direction:column;align-items:center;gap:2px;flex-shrink:0;opacity:0;transition:opacity .3s;}
.feedback.show{opacity:1;}
.feedback.good{background:var(--green-bg);color:var(--green-deep);}
.feedback.bad{background:var(--red-bg);color:var(--red-deep);}
.eq{font-size:1rem;font-weight:900;}

/* Mic status â€” invisible unless active */
.mic-st{margin:3px 14px 0;border-radius:8px;padding:4px 12px;font-size:.72rem;font-weight:800;text-align:center;flex-shrink:0;opacity:0;transition:opacity .2s;}
.mic-st.listening{opacity:1;background:var(--green-bg);color:var(--green-deep);animation:pulse 1s ease infinite;}
.mic-st.heard{opacity:1;background:#fff8d6;color:#7a5500;}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}

/* ANSWERS â€” fills ALL remaining vertical space */
.ans-grid{display:grid;grid-template-columns:1fr 1fr;grid-template-rows:1fr 1fr;gap:28px;padding:10px 18px 14px;flex:1;min-height:0;}

.ans-btn{border:5px solid transparent;border-radius:26px;cursor:pointer;display:flex;flex-direction:column;align-items:stretch;overflow:hidden;box-shadow:0 5px 18px rgba(0,0,0,.12);transition:transform .14s;}
.ans-btn:active{transform:scale(.96);}
.btn-bar{height:20px;flex-shrink:0;border-radius:20px 20px 0 0;}
.btn-num{flex:1;display:flex;align-items:center;justify-content:center;font-size:clamp(4rem,18vw,9rem);font-weight:900;line-height:1.05;padding:8px;text-align:center;overflow:hidden;}

.ans-btn.blue{background:var(--blue-bg);border-color:var(--blue-mid);}
.ans-btn.blue .btn-bar{background:var(--blue-mid);}
.ans-btn.blue .btn-num{color:var(--blue-txt);}
.ans-btn.green{background:var(--green-bg);border-color:var(--green-mid);}
.ans-btn.green .btn-bar{background:var(--green-mid);}
.ans-btn.green .btn-num{color:var(--green-txt);}
.ans-btn.purple{background:var(--purple-bg);border-color:var(--purple-mid);}
.ans-btn.purple .btn-bar{background:var(--purple-mid);}
.ans-btn.purple .btn-num{color:var(--purple-txt);}
.ans-btn.red{background:var(--red-bg);border-color:var(--red-mid);}
.ans-btn.red .btn-bar{background:var(--red-mid);}
.ans-btn.red .btn-num{color:var(--red-txt);}
.ans-btn.correct{box-shadow:0 0 0 7px var(--green-mid)!important;animation:pop .3s ease;}
.ans-btn.wrong{opacity:.3;}
@keyframes pop{0%{transform:scale(1)}45%{transform:scale(1.05)}100%{transform:scale(1)}}

.quiz-bottom{background:white;box-shadow:0 -2px 10px rgba(0,0,0,.07);padding:10px 20px calc(env(safe-area-inset-bottom,0px) + 10px);display:flex;align-items:center;justify-content:center;gap:20px;flex-shrink:0;}
.mic-btn{width:60px;height:60px;border-radius:50%;border:none;background:var(--blue-mid);color:white;font-size:1.5rem;cursor:pointer;box-shadow:0 4px 16px rgba(74,127,224,.4);transition:all .15s;}
.mic-btn.active{background:var(--green-mid);animation:pulse 1s ease infinite;}
.next-btn{background:#2a5fa8;color:white;border:none;border-radius:14px;padding:14px 30px;font-family:'Nunito',sans-serif;font-size:1rem;font-weight:900;cursor:pointer;display:none;}

/* PROGRESS */
#progress{background:var(--bg);}
/* â•â• GAME SETUP â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#game-setup{background:linear-gradient(160deg,#1a1a4e,#2a2a8a,#4a4ac8);overflow-y:auto;align-items:center;padding:env(safe-area-inset-top,20px) 20px env(safe-area-inset-bottom,20px);}
.gs-title{font-size:clamp(1.6rem,7vw,2.4rem);font-weight:900;color:white;margin-top:10px;}
.gs-sub{font-size:.85rem;color:rgba(255,255,255,.7);font-weight:700;margin-top:2px;margin-bottom:14px;}
.gs-section{color:rgba(255,255,255,.7);font-size:.7rem;font-weight:800;text-transform:uppercase;letter-spacing:1px;align-self:flex-start;margin-bottom:8px;margin-top:14px;}
.gs-row{display:flex;gap:8px;flex-wrap:wrap;align-self:flex-start;}
.gs-btn{background:rgba(255,255,255,.15);border:2px solid rgba(255,255,255,.3);border-radius:40px;padding:8px 18px;font-family:'Nunito',sans-serif;font-size:.85rem;font-weight:800;cursor:pointer;color:white;transition:all .15s;}
.gs-btn.active{background:white;color:#2a2a8a;border-color:white;}
.gs-subj-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;width:100%;max-width:500px;margin-top:4px;}
.gs-subj-card{border-radius:16px;padding:14px 10px;display:flex;flex-direction:column;align-items:center;gap:4px;cursor:pointer;transition:transform .15s;box-shadow:0 4px 14px rgba(0,0,0,.2);border:3px solid transparent;opacity:.65;}
.gs-subj-card:active{transform:scale(.96);}
.gs-subj-card.sel{border-color:white;opacity:1;box-shadow:0 0 0 4px rgba(255,255,255,.35);}
.gs-subj-card.math{background:linear-gradient(135deg,#2a5fa8,#5b9bd5);}
.gs-subj-card.read{background:linear-gradient(135deg,#1a7a4a,#3db87a);}
.gs-subj-card.life{background:linear-gradient(135deg,#a84a10,#f07a3a);}
.gs-subj-card.sci{background:linear-gradient(135deg,#5c3db8,#9b7fd4);}
.gs-subj-card.mix{background:linear-gradient(135deg,#7a1a7a,#d45bd4);}
.gs-s-icon{font-size:1.6rem;}.gs-s-name{font-size:.8rem;font-weight:900;color:white;}
.gs-start{background:white;color:#2a2a8a;border:none;border-radius:20px;padding:16px 50px;font-family:'Nunito',sans-serif;font-size:1.1rem;font-weight:900;cursor:pointer;margin-top:20px;box-shadow:0 6px 20px rgba(0,0,0,.2);transition:transform .15s;}
.gs-start:active{transform:scale(.96);}

/* â•â• GAME SCREEN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#game{background:var(--bg);}
.game-hdr{display:flex;align-items:center;gap:10px;padding:env(safe-area-inset-top,10px) 16px 10px;background:white;box-shadow:0 2px 8px rgba(0,0,0,.07);flex-shrink:0;}
.game-subj{font-size:.95rem;font-weight:900;}
.game-score-wrap{margin-left:auto;display:flex;flex-direction:column;align-items:flex-end;}
.game-score-lbl{font-size:.55rem;font-weight:800;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;}
.game-score{font-size:1.6rem;font-weight:900;color:#2a5fa8;line-height:1;}
.timer-wrap{padding:8px 16px 2px;flex-shrink:0;}
.timer-bg{background:#dde3f5;border-radius:40px;height:16px;overflow:hidden;}
.timer-fill{height:100%;border-radius:40px;background:linear-gradient(90deg,#e85555 0%,#f0a030 50%,#3db87a 100%);transition:width .25s linear;}
.score-flash{position:fixed;top:40%;left:50%;transform:translate(-50%,-50%);font-size:2.8rem;font-weight:900;pointer-events:none;opacity:0;z-index:500;}
.score-flash.plus{color:var(--green-deep);animation:flashUp .7s ease forwards;}
.score-flash.minus{color:#c0392b;animation:flashUp .7s ease forwards;}
@keyframes flashUp{0%{opacity:1;transform:translate(-50%,-50%)}100%{opacity:0;transform:translate(-50%,-120%)}}

/* â•â• GAME END â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#game-end{background:linear-gradient(160deg,#1a1a4e,#2a2a8a,#4a4ac8);align-items:center;justify-content:center;text-align:center;padding:32px 24px;overflow-y:auto;}
.ge-trophy{font-size:5rem;animation:bounce .7s ease infinite alternate;margin-bottom:6px;}
.ge-title{font-size:clamp(1.6rem,6vw,2.4rem);font-weight:900;color:white;margin-bottom:4px;}
.ge-score{font-size:clamp(4rem,18vw,7rem);font-weight:900;color:#ffd700;line-height:1;margin:8px 0;}
.ge-score-lbl{font-size:.9rem;color:rgba(255,255,255,.7);font-weight:800;margin-bottom:16px;}
.ge-best{background:rgba(255,255,255,.15);border-radius:16px;padding:12px 24px;color:white;font-weight:800;font-size:.95rem;margin-bottom:20px;}
.ge-best.new-record{background:rgba(255,215,0,.2);border:2px solid gold;animation:glow 1.5s ease infinite alternate;}
@keyframes glow{from{box-shadow:0 0 8px rgba(255,215,0,.3)}to{box-shadow:0 0 24px rgba(255,215,0,.8)}}
.ge-btn{background:white;color:#2a2a8a;border:none;border-radius:16px;padding:14px 34px;font-family:'Nunito',sans-serif;font-size:1rem;font-weight:900;cursor:pointer;margin:5px;}
.ge-btn.outline{background:transparent;border:2px solid rgba(255,255,255,.5);color:white;}


/* â•â• SETTINGS SCREEN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#settings{background:linear-gradient(160deg,#1e3a7a,#2a5fa8,#4a8fd8);overflow-y:auto;align-items:center;padding:env(safe-area-inset-top,20px) 20px env(safe-area-inset-bottom,20px);}
.set-hdr{display:flex;align-items:center;gap:12px;align-self:flex-start;margin-bottom:20px;width:100%;}
.set-title{font-size:clamp(1.4rem,6vw,2rem);font-weight:900;color:white;}
.set-card{background:rgba(255,255,255,.12);border-radius:20px;padding:16px 18px;width:100%;max-width:500px;margin-bottom:14px;}
.set-card-title{font-size:.7rem;font-weight:900;color:rgba(255,255,255,.6);text-transform:uppercase;letter-spacing:1px;margin-bottom:12px;}
.set-row{display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid rgba(255,255,255,.1);}
.set-row:last-child{border-bottom:none;}
.set-row-label{font-size:.9rem;font-weight:800;color:white;}
.set-row-sub{font-size:.7rem;color:rgba(255,255,255,.55);font-weight:700;margin-top:1px;}
.set-toggle{width:52px;height:30px;border-radius:30px;border:none;cursor:pointer;position:relative;transition:background .2s;flex-shrink:0;}
.set-toggle.on{background:#3db87a;}.set-toggle.off{background:rgba(255,255,255,.25);}
.set-toggle::after{content:'';position:absolute;top:3px;width:24px;height:24px;border-radius:50%;background:white;transition:left .2s;box-shadow:0 2px 4px rgba(0,0,0,.2);}
.set-toggle.on::after{left:25px;}.set-toggle.off::after{left:3px;}
.set-opts{display:flex;gap:6px;flex-wrap:wrap;}
.set-opt{background:rgba(255,255,255,.18);border:2px solid rgba(255,255,255,.3);border-radius:30px;padding:5px 14px;font-family:'Nunito',sans-serif;font-size:.78rem;font-weight:800;cursor:pointer;color:white;transition:all .15s;}
.set-opt.active{background:white;color:#2a5fa8;border-color:white;}
.vol-row{display:flex;align-items:center;gap:10px;padding:8px 0;}
.vol-slider{flex:1;height:6px;border-radius:6px;accent-color:#3db87a;cursor:pointer;}

/* â•â• CALM / BREAK SCREEN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#calm{background:linear-gradient(160deg,#0a1628,#0d2444,#0a1e38);align-items:center;justify-content:center;text-align:center;padding:32px;}
.calm-title{font-size:clamp(1.4rem,5vw,2rem);font-weight:900;color:rgba(255,255,255,.9);margin-bottom:6px;}
.calm-sub{font-size:.9rem;color:rgba(255,255,255,.5);font-weight:700;margin-bottom:30px;}
.calm-anim{position:relative;width:180px;height:180px;margin:0 auto 24px;}
.calm-circle{position:absolute;border-radius:50%;animation:calmPulse 4s ease-in-out infinite;}
.calm-c1{width:180px;height:180px;background:rgba(74,120,200,.15);top:0;left:0;animation-delay:0s;}
.calm-c2{width:130px;height:130px;background:rgba(74,120,200,.2);top:25px;left:25px;animation-delay:.5s;}
.calm-c3{width:80px;height:80px;background:rgba(100,160,255,.35);top:50px;left:50px;animation-delay:1s;}
.calm-note{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:2.5rem;}
@keyframes calmPulse{0%,100%{transform:scale(1);opacity:.7}50%{transform:scale(1.12);opacity:1}}
.calm-timer-wrap{width:200px;margin:0 auto 20px;}
.calm-timer-bg{background:rgba(255,255,255,.1);border-radius:40px;height:10px;overflow:hidden;}
.calm-timer-fill{height:100%;border-radius:40px;background:linear-gradient(90deg,#5b9bd5,#9b7fd4);transition:width 1s linear;}
.calm-timer-lbl{font-size:.75rem;color:rgba(255,255,255,.5);font-weight:800;margin-top:6px;}
.calm-ready-btn{background:rgba(255,255,255,.15);border:2px solid rgba(255,255,255,.3);border-radius:20px;padding:14px 36px;font-family:'Nunito',sans-serif;font-size:1rem;font-weight:900;color:white;cursor:pointer;margin-top:8px;}
.calm-ready-btn:active{transform:scale(.96);}

/* BREAK BUTTON styles */
.break-btn-big{position:absolute;bottom:90px;right:14px;background:rgba(91,155,213,.9);border:none;border-radius:16px;padding:10px 16px;font-family:'Nunito',sans-serif;font-size:.82rem;font-weight:900;color:white;cursor:pointer;box-shadow:0 4px 14px rgba(0,0,0,.2);z-index:10;display:none;}
.break-btn-small{position:absolute;bottom:92px;right:14px;background:rgba(91,155,213,.7);border:none;border-radius:50%;width:42px;height:42px;font-size:1.2rem;cursor:pointer;box-shadow:0 3px 10px rgba(0,0,0,.15);z-index:10;display:none;}
.break-btn-big.show,.break-btn-small.show{display:block;}

/* MUTE button in quiz header */
.mute-btn{background:none;border:none;font-size:1.2rem;cursor:pointer;padding:4px;border-radius:8px;margin-left:4px;}

/* TRANSITION WARNING */
.transition-warn{margin:4px 14px 0;background:rgba(255,200,50,.15);border:1px solid rgba(255,200,50,.3);border-radius:10px;padding:5px 14px;font-size:.72rem;font-weight:800;color:#8a6800;text-align:center;flex-shrink:0;display:none;}
.transition-warn.show{display:block;}
.prog-hdr{background:white;padding:env(safe-area-inset-top,12px) 18px 12px;display:flex;align-items:center;gap:12px;box-shadow:0 2px 8px rgba(0,0,0,.06);flex-shrink:0;}
.prog-hdr h2{font-size:1.1rem;font-weight:900;}
.prog-content{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:14px;}
.stat-card{background:white;border-radius:18px;padding:16px 18px;box-shadow:0 3px 12px rgba(0,0,0,.07);}
.stat-card h3{font-size:.7rem;font-weight:900;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:10px;}
.stat-row{display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid #f0f0f0;}
.stat-row:last-child{border-bottom:none;}
.stat-lbl{font-size:.88rem;font-weight:700;}
.stat-val{font-size:.95rem;font-weight:900;}
.stat-val.green{color:var(--green-deep);}
.subj-bar{height:8px;border-radius:8px;background:#eee;overflow:hidden;flex:1;margin:0 10px;}
.subj-fill{height:100%;border-radius:8px;transition:width .6s ease;}
.print-btn{background:#2a5fa8;color:white;border:none;border-radius:14px;padding:14px;font-family:'Nunito',sans-serif;font-size:.95rem;font-weight:900;cursor:pointer;text-align:center;}

/* CELEBRATION */
.cel{position:fixed;inset:0;background:rgba(255,255,255,.97);display:none;flex-direction:column;align-items:center;justify-content:center;text-align:center;gap:14px;z-index:999;padding:32px;}
.cel.show{display:flex;animation:fadeUp .35s ease;}
.trophy{font-size:5rem;animation:bounce .7s ease infinite alternate;}
@keyframes bounce{from{transform:translateY(0)}to{transform:translateY(-12px)}}
.cel h1{font-size:clamp(1.6rem,6vw,2.2rem);font-weight:900;color:#2a5fa8;}
.cel p{font-size:1rem;color:var(--muted);font-weight:700;max-width:420px;}
.cel-btn{background:#2a5fa8;color:white;border:none;border-radius:16px;padding:14px 34px;font-family:'Nunito',sans-serif;font-size:1.05rem;font-weight:900;cursor:pointer;margin-top:4px;}
.cel-btn.outline{background:transparent;border:3px solid #2a5fa8;color:#2a5fa8;}
</style>
</head>
<body>

<!-- HOME -->
<div class="screen active" id="home">
  <div class="home-logo">ğŸŒŸ</div>
  <div class="home-title">ShaanSmart</div>
  <div class="home-sub">Shaan's Learning Adventure</div>
  <div class="stars-strip">â­ <span id="home-stars">0</span> stars &nbsp;Â·&nbsp; ğŸ”¥ <span id="home-streak">0</span> day streak</div>
  <div class="sec-lbl">Grade Level</div>
  <div class="grade-row">
    <button class="grade-btn active" onclick="setGrade(2)" id="g2">Grade 2</button>
    <button class="grade-btn" onclick="setGrade(3)" id="g3">Grade 3</button>
    <button class="grade-btn" onclick="setGrade(4)" id="g4">Grade 4</button>
    <button class="grade-btn" onclick="setGrade(5)" id="g5">Grade 5</button>
  </div>
  <div class="sec-lbl" style="margin-top:4px">Choose a Subject</div>
  <div class="subject-grid">
    <div class="subject-card math" onclick="startSubject('math')"><div class="s-badge" id="math-badge">â€”</div><div class="s-icon">ğŸ”¢</div><div class="s-name">Math</div><div class="s-count">Multiply Â· Divide Â· Fill-in</div></div>
    <div class="subject-card read" onclick="startSubject('reading')"><div class="s-badge" id="reading-badge">â€”</div><div class="s-icon">ğŸ“–</div><div class="s-name">Reading</div><div class="s-count">Words Â· Stories Â· Rhymes</div></div>
    <div class="subject-card life" onclick="startSubject('life')"><div class="s-badge" id="life-badge">â€”</div><div class="s-icon">ğŸ </div><div class="s-name">Life Skills</div><div class="s-count">Daily Â· Safety Â· Social</div></div>
    <div class="subject-card sci" onclick="startSubject('science')"><div class="s-badge" id="science-badge">â€”</div><div class="s-icon">ğŸ”¬</div><div class="s-name">Science</div><div class="s-count">Nature Â· Earth Â· Animals</div></div>
  </div>
  <button onclick="showScreen('game-setup')" style="background:linear-gradient(135deg,#ffd700,#ff8c00);border:none;border-radius:20px;padding:14px 40px;font-family:'Nunito',sans-serif;font-size:1rem;font-weight:900;color:#1a1a00;cursor:pointer;box-shadow:0 6px 20px rgba(0,0,0,.25);margin-bottom:16px;width:100%;max-width:500px;transition:transform .15s;" onmousedown="this.style.transform='scale(.97)'" onmouseup="this.style.transform='scale(1)'">âš¡ Game Mode â€” Beat the Clock!</button>
  <div class="nav-bar">
    <button class="nav-item active" onclick="showScreen('home')"><span class="nav-icon">ğŸ </span><span class="nav-label">Home</span></button>
    <button class="nav-item" onclick="showScreen('progress')"><span class="nav-icon">ğŸ“Š</span><span class="nav-label">Progress</span></button>
    <button class="nav-item" onclick="showScreen('settings')"><span class="nav-icon">âš™ï¸</span><span class="nav-label">Settings</span></button>
  </div>
</div>

<!-- QUIZ -->
<div class="screen" id="quiz">
  <div class="quiz-hdr">
    <button class="back-btn" onclick="showScreen('home')">â†</button>
    <span class="quiz-subj" id="quiz-subj">Math</span>
    <button class="mute-btn" id="mute-btn" onclick="toggleMute()">ğŸ”Š</button>
    <div class="quiz-stars">â­ <span id="quiz-stars">0</span></div>
  </div>
  <div class="prog-wrap">
    <div class="prog-lbl" id="prog-lbl">Question 1 of 10</div>
    <div class="prog-bg"><div class="prog-fill" id="prog-fill" style="width:0%"></div></div>
  </div>
  <div class="q-box" id="q-box"></div>
  <div class="feedback" id="feedback"></div>
  <div class="transition-warn" id="transition-warn">Almost done! Last 2 questions ğŸŒŸ</div>
  <div class="mic-st" id="mic-st"></div>
  <div class="ans-grid" id="ans-grid"></div>
  <button class="break-btn-big" id="break-btn-big" onclick="startCalm()">ğŸ§˜ Take a Break</button>
  <button class="break-btn-small" id="break-btn-small" onclick="startCalm()">ğŸ§˜</button>
  <div class="quiz-bottom">
    <button class="mic-btn" id="mic-btn" onclick="toggleMic()">ğŸ¤</button>
    <button class="next-btn" id="next-btn" onclick="nextQ()">Next â¡ï¸</button>
  </div>
</div>


<!-- GAME SETUP -->
<div class="screen" id="game-setup">
  <div style="font-size:3rem;margin-top:12px;animation:float 2s ease-in-out infinite">âš¡</div>
  <div class="gs-title">Game Mode</div>
  <div class="gs-sub">How many can Shaan get right?</div>

  <div class="gs-section">Pick a subject</div>
  <div class="gs-subj-grid">
    <div class="gs-subj-card math sel" onclick="gsPickSubj('math',this)"><div class="gs-s-icon">ğŸ”¢</div><div class="gs-s-name">Math</div></div>
    <div class="gs-subj-card read" onclick="gsPickSubj('reading',this)"><div class="gs-s-icon">ğŸ“–</div><div class="gs-s-name">Reading</div></div>
    <div class="gs-subj-card life" onclick="gsPickSubj('life',this)"><div class="gs-s-icon">ğŸ </div><div class="gs-s-name">Life Skills</div></div>
    <div class="gs-subj-card sci" onclick="gsPickSubj('science',this)"><div class="gs-s-icon">ğŸ”¬</div><div class="gs-s-name">Science</div></div>
    <div class="gs-subj-card mix" onclick="gsPickSubj('mix',this)" style="grid-column:1/-1"><div class="gs-s-icon">ğŸŒŸ</div><div class="gs-s-name">Mix â€” All Subjects!</div></div>
  </div>

  <div class="gs-section">Time limit</div>
  <div class="gs-row">
    <button class="gs-btn" onclick="gsPickTime(30,this)">30 sec</button>
    <button class="gs-btn active" onclick="gsPickTime(60,this)">60 sec</button>
    <button class="gs-btn" onclick="gsPickTime(90,this)">90 sec</button>
    <button class="gs-btn" onclick="gsPickTime(120,this)">2 min</button>
  </div>

  <button class="gs-start" onclick="startGame()">âš¡ Let's Go!</button>
  <button class="gs-btn" onclick="showScreen('home')" style="margin-top:12px;align-self:center">â† Back</button>
</div>

<!-- GAME SCREEN -->
<div class="screen" id="game">
  <div class="game-hdr">
    <button class="back-btn" onclick="stopGame()">â†</button>
    <span class="game-subj" id="game-subj">Math</span>
    <div class="game-score-wrap">
      <div class="game-score-lbl">Score</div>
      <div class="game-score" id="game-score">0</div>
    </div>
  </div>
  <button class="break-btn-big" id="game-break-btn-big" onclick="startCalm()">ğŸ§˜ Take a Break</button>
  <button class="break-btn-small" id="game-break-btn-small" onclick="startCalm()">ğŸ§˜</button>
  <div class="timer-wrap">
    <div class="timer-bg"><div class="timer-fill" id="timer-fill" style="width:100%"></div></div>
  </div>
  <div class="q-box" id="game-q-box"></div>
  <div class="feedback" id="game-feedback"></div>
  <div class="ans-grid" id="game-ans-grid"></div>
</div>

<!-- GAME END -->
<div class="screen" id="game-end">
  <div class="ge-trophy">ğŸ†</div>
  <div class="ge-title" id="ge-title">Time's up!</div>
  <div class="ge-score" id="ge-score">0</div>
  <div class="ge-score-lbl">points</div>
  <div class="ge-best" id="ge-best">Personal best: 0</div>
  <div style="font-size:1.6rem;margin-bottom:16px">â­â­â­â­â­</div>
  <button class="ge-btn" onclick="startGame()">âš¡ Play Again!</button>
  <button class="ge-btn outline" onclick="showScreen('game-setup')">Change Settings</button>
  <button class="ge-btn outline" onclick="showScreen('home')">ğŸ  Home</button>
</div>

<!-- SCORE FLASH -->
<div class="score-flash" id="score-flash"></div>


<!-- SETTINGS -->
<div class="screen" id="settings">
  <div style="background:rgba(0,0,0,.2);padding:env(safe-area-inset-top,12px) 16px 12px;display:flex;align-items:center;gap:12px;flex-shrink:0;">
    <button class="back-btn" style="color:white" onclick="showScreen('home')">â†</button>
    <div class="set-title">Settings</div>
  </div>
  <div style="flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;align-items:center;gap:0;">

    <!-- SOUND -->
    <div class="set-card">
      <div class="set-card-title">ğŸ”Š Sound</div>
      <div class="set-row">
        <div><div class="set-row-label">Voice Feedback</div><div class="set-row-sub">Cheers and praise after correct answers</div></div>
        <button class="set-toggle on" id="tog-voice" onclick="toggleSetting('voice',this)"></button>
      </div>
      <div class="set-row">
        <div><div class="set-row-label">Volume</div></div>
        <div style="display:flex;align-items:center;gap:8px;">
          <span style="font-size:.8rem;color:rgba(255,255,255,.6)">ğŸ”ˆ</span>
          <input type="range" class="vol-slider" id="vol-slider" min="0" max="100" value="80" oninput="setVolume(this.value)">
          <span style="font-size:.8rem;color:rgba(255,255,255,.6)">ğŸ”Š</span>
        </div>
      </div>
    </div>

    <!-- SESSION -->
    <div class="set-card">
      <div class="set-card-title">ğŸ“š Session Length</div>
      <div class="set-row">
        <div><div class="set-row-label">Questions per round</div></div>
        <div class="set-opts">
          <button class="set-opt" id="sq5" onclick="setQCount(5,this)">5</button>
          <button class="set-opt active" id="sq10" onclick="setQCount(10,this)">10</button>
        </div>
      </div>
    </div>

    <!-- BREAK BUTTON -->
    <div class="set-card">
      <div class="set-card-title">ğŸ§˜ Break Button</div>
      <div class="set-row">
        <div><div class="set-row-label">Show break button during quiz</div></div>
        <button class="set-toggle on" id="tog-break" onclick="toggleSetting('break',this)"></button>
      </div>
      <div class="set-row" id="break-style-row">
        <div><div class="set-row-label">Button style</div><div class="set-row-sub">Big = easier to find Â· Small = less distraction</div></div>
        <div class="set-opts">
          <button class="set-opt active" id="bs-big" onclick="setBreakStyle('big',this)">Big</button>
          <button class="set-opt" id="bs-small" onclick="setBreakStyle('small',this)">Small</button>
        </div>
      </div>
    </div>

    <!-- CALM SCREEN -->
    <div class="set-card">
      <div class="set-card-title">ğŸŒ™ Calm Break Duration</div>
      <div class="set-row">
        <div><div class="set-row-label">How long is the break?</div></div>
        <div class="set-opts">
          <button class="set-opt" id="cd30" onclick="setCalmDur(30,this)">30s</button>
          <button class="set-opt active" id="cd60" onclick="setCalmDur(60,this)">60s</button>
          <button class="set-opt" id="cd90" onclick="setCalmDur(90,this)">90s</button>
          <button class="set-opt" id="cd120" onclick="setCalmDur(120,this)">2 min</button>
        </div>
      </div>
    </div>

    <!-- GAME MODE -->
    <div class="set-card">
      <div class="set-card-title">âš¡ Game Mode Default Timer</div>
      <div class="set-row">
        <div><div class="set-row-label">Default time limit</div></div>
        <div class="set-opts">
          <button class="set-opt" id="gt30" onclick="setGameTime(30,this)">30s</button>
          <button class="set-opt active" id="gt60" onclick="setGameTime(60,this)">60s</button>
          <button class="set-opt" id="gt90" onclick="setGameTime(90,this)">90s</button>
          <button class="set-opt" id="gt120" onclick="setGameTime(120,this)">2 min</button>
        </div>
      </div>
    </div>

    <div style="height:16px"></div>
  </div>
</div>

<!-- CALM BREAK SCREEN -->
<div class="screen" id="calm">
  <div class="calm-title">Take a Deep Breath ğŸŒ™</div>
  <div class="calm-sub">Relaxâ€¦ Shaan is doing great</div>
  <div class="calm-anim">
    <div class="calm-circle calm-c1"></div>
    <div class="calm-circle calm-c2"></div>
    <div class="calm-circle calm-c3"></div>
    <div class="calm-note">ğŸµ</div>
  </div>
  <div class="calm-timer-wrap">
    <div class="calm-timer-bg"><div class="calm-timer-fill" id="calm-fill" style="width:100%"></div></div>
    <div class="calm-timer-lbl" id="calm-lbl">60 seconds</div>
  </div>
  <button class="calm-ready-btn" onclick="endCalm()">I'm Ready âœ¨</button>
</div>

<!-- PROGRESS -->
<div class="screen" id="progress">
  <div class="prog-hdr">
    <button class="back-btn" onclick="showScreen('home')">â†</button>
    <h2>Shaan's Progress</h2>
  </div>
  <div class="prog-content" id="prog-content"></div>
  <div class="nav-bar">
    <button class="nav-item" onclick="showScreen('home')"><span class="nav-icon">ğŸ </span><span class="nav-label">Home</span></button>
    <button class="nav-item active" onclick="showScreen('progress')"><span class="nav-icon">ğŸ“Š</span><span class="nav-label">Progress</span></button>
    <button class="nav-item" onclick="showScreen('settings')"><span class="nav-icon">âš™ï¸</span><span class="nav-label">Settings</span></button>
  </div>
</div>

<!-- CELEBRATION -->
<div class="cel" id="cel">
  <div class="trophy">ğŸ†</div>
  <h1>Shaan, you are AMAZING!</h1>
  <p id="cel-msg"></p>
  <div style="font-size:2rem">â­â­â­â­â­</div>
  <button class="cel-btn" onclick="newRound()">Keep Going! ğŸš€</button>
  <button class="cel-btn outline" onclick="showScreen('home')" style="margin-top:6px">Back to Home</button>
</div>

<script>
const COLORS=[{id:'blue',spoken:['blue']},{id:'green',spoken:['green']},{id:'purple',spoken:['purple']},{id:'red',spoken:['red']}];
const CHEERS=["Shaan, you are absolutely amazing! I knew you could do it!","Yes! Shaan got it right! You are SO smart!","Wow Shaan! That is exactly right! You should be so proud!","Shaan, you are a superstar! Keep going!","Oh my goodness Shaan! Perfect answer! You are incredible!","That's right Shaan! You are brilliant! I am so proud of you!","Shaan, you did it again! You are totally on fire today!","Amazing Shaan! You are seriously so clever! Great job!","Yes yes yes! Shaan is unstoppable! What an absolute superstar!"];
const SUBJ={math:{name:'ğŸ”¢ Math',color:'#2a5fa8'},reading:{name:'ğŸ“– Reading',color:'#1a7a4a'},life:{name:'ğŸ  Life',color:'#a84a10'},science:{name:'ğŸ”¬ Science',color:'#5c3db8'}};

// VOICE
let voice=null;
function loadVoice(){const vs=window.speechSynthesis?.getVoices()||[];if(!vs.length)return;const tests=[v=>v.name==='Samantha',v=>v.name==='Karen',v=>v.name==='Tessa',v=>/Zira/i.test(v.name),v=>/Jenny/i.test(v.name)&&v.lang.startsWith('en'),v=>/Aria/i.test(v.name)&&v.lang.startsWith('en'),v=>v.lang==='en-AU',v=>v.lang==='en-US'];for(const t of tests){const m=vs.find(t);if(m){voice=m;break;}}}
if(window.speechSynthesis){window.speechSynthesis.onvoiceschanged=loadVoice;loadVoice();}
function speak(txt,rate=0.82,pitch=1.22){if(!window.speechSynthesis||!txt)return;window.speechSynthesis.cancel();const u=new SpeechSynthesisUtterance(txt);if(voice)u.voice=voice;u.rate=rate;u.pitch=pitch;u.volume=1;window.speechSynthesis.speak(u);}
const cheer=t=>speak(t,.79,1.32);
const gentle=t=>speak(t,.80,1.10);

// PROGRESS
const KEY='shaansmart_v1';let P={};
function loadP(){try{P=JSON.parse(localStorage.getItem(KEY)||'{}');}catch(e){P={};}P.totalStars=P.totalStars||0;P.sessions=P.sessions||[];P.bySubject=P.bySubject||{};P.streak=P.streak||0;P.lastDate=P.lastDate||null;}
function saveP(){try{localStorage.setItem(KEY,JSON.stringify(P));}catch(e){}}
function logSess(subj,grade,total,correct,wrongs){
  const today=new Date().toISOString().split('T')[0];
  if(P.lastDate!==today){const yd=new Date();yd.setDate(yd.getDate()-1);P.streak=P.lastDate===yd.toISOString().split('T')[0]?P.streak+1:1;P.lastDate=today;}
  P.totalStars+=correct;
  if(!P.bySubject[subj])P.bySubject[subj]={attempts:0,correct:0,wrong:[]};
  const s=P.bySubject[subj];s.attempts+=total;s.correct+=correct;s.wrong=[...(s.wrong||[]),...wrongs].slice(-30);
  P.sessions=[...P.sessions,{date:today,subj,grade,total,correct}].slice(-100);
  saveP();badges();
}
function badges(){
  document.getElementById('home-stars').textContent=P.totalStars||0;
  document.getElementById('home-streak').textContent=P.streak||0;
  document.getElementById('quiz-stars').textContent=P.totalStars||0;
  ['math','reading','life','science'].forEach(s=>{const d=P.bySubject[s];const el=document.getElementById(s+'-badge');if(el&&d&&d.attempts>0)el.textContent=Math.round(d.correct/d.attempts*100)+'%';});
}

// QUESTION BANKS
const sh=arr=>{const a=[...arr];for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;};
function gD(ans,a,b){const s=new Set([ans+1,ans-1,a+b,ans+b,ans-a,ans+3]);return[...s].filter(x=>x>0&&x!==ans).sort(()=>Math.random()-.5).slice(0,3).map(String);}
const M={2:[[2,2],[2,3],[2,4],[2,5],[3,3],[3,4],[4,2],[5,2]],3:[[2,6],[2,7],[2,8],[2,9],[3,5],[3,6],[4,4],[4,5],[5,5]],4:[[3,7],[3,8],[4,6],[4,7],[5,6],[5,7],[6,6],[7,3]],5:[[4,8],[5,8],[5,9],[6,7],[6,8],[7,7],[7,8],[8,8],[9,6],[12,7]]};
const D={2:[[4,2],[6,2],[6,3],[8,2],[8,4],[9,3]],3:[[12,3],[12,4],[15,3],[16,4],[18,6],[20,4]],4:[[24,6],[24,8],[28,4],[32,8],[36,9],[42,7]],5:[[48,6],[56,7],[63,9],[72,8],[81,9],[84,7]]};
function mathBank(grade){const g=Math.min(Math.max(grade,2),5);const mp=M[g]||M[3];const dp=D[g]||D[3];const qs=[];sh(mp).slice(0,4).forEach(([a,b])=>{const ans=a*b;qs.push({badge:'âœ–ï¸ Multiply',bc:'#2a5fa8',text:`${a} Ã— ${b} = ?`,eq:`${a} Ã— ${b} = ${ans}`,answer:String(ans),dist:gD(ans,a,b)});});sh(dp).slice(0,3).forEach(([a,b])=>{const p=a*b;qs.push({badge:'â— Divide',bc:'#1a7a4a',text:`${p} Ã· ${b} = ?`,eq:`${p} Ã· ${b} = ${a}`,answer:String(a),dist:gD(a,p,b)});});sh(mp).slice(0,3).forEach(([a,b])=>{const ans=a*b;const slot=Math.random()<.5?'first':'second';const cor=slot==='first'?String(a):String(b);qs.push({badge:'ğŸ”² Fill in',bc:'#5c3db8',text:slot==='first'?`___ Ã— ${b} = ${ans}`:`${a} Ã— ___ = ${ans}`,eq:`${a} Ã— ${b} = ${ans}`,answer:cor,dist:gD(Number(cor),a,b)});});return sh(qs).slice(0,10);}
const RB={2:[{image:'ğŸ±',badge:'ğŸ“– Words',bc:'#1a7a4a',text:'What word matches this picture?',answer:'CAT',dist:['DOG','RAT','BAT']},{image:'â˜€ï¸',badge:'ğŸ“– Reading',bc:'#1a7a4a',text:'Which word describes the sun?',answer:'HOT',dist:['WET','COLD','DARK']},{image:'ğŸ ',badge:'ğŸ“– Rhymes',bc:'#1a7a4a',text:'Which word rhymes with HOUSE?',answer:'MOUSE',dist:['TREE','BOOK','CAKE']},{image:'ğŸ¶',badge:'ğŸ“– Reading',bc:'#1a7a4a',text:'The dog ran fast. What did the dog do?',answer:'RAN',dist:['ATE','SLEPT','SWAM']},{image:'ğŸŒ§ï¸',badge:'ğŸ“– Words',bc:'#1a7a4a',text:'What is falling from the sky?',answer:'RAIN',dist:['SNOW','HAIL','LEAVES']},{image:'ğŸ‚',badge:'ğŸ“– Rhymes',bc:'#1a7a4a',text:'Which word rhymes with CAKE?',answer:'LAKE',dist:['FISH','TREE','BALL']},{image:'ğŸŒ³',badge:'ğŸ“– Words',bc:'#1a7a4a',text:'Leaves grow on a ___.',answer:'TREE',dist:['HOUSE','CAR','BOOK']}],3:[{image:'ğŸ¦‹',badge:'ğŸ“– Reading',bc:'#1a7a4a',text:'"The butterfly was beautiful." Beautiful means:',answer:'Pretty to look at',dist:['Very loud','Smells bad','Really fast']},{image:'ğŸŒŠ',badge:'ğŸ“– Words',bc:'#1a7a4a',text:'A large body of water is called:',answer:'OCEAN',dist:['RIVER','POND','PUDDLE']},{image:'ğŸ˜',badge:'ğŸ“– Reading',bc:'#1a7a4a',text:'"Elephants are enormous." Enormous means:',answer:'Very big',dist:['Very fast','Very loud','Very soft']},{image:'ğŸ”¥',badge:'ğŸ“– Rhymes',bc:'#1a7a4a',text:'Which word rhymes with HEAT?',answer:'BEAT',dist:['COOL','BURN','WAVE']},{image:'ğŸ†',badge:'ğŸ“– Words',bc:'#1a7a4a',text:'First place winner is called a:',answer:'CHAMPION',dist:['PLAYER','TEAM','COACH']}]};
function readingBank(g){return sh(g<=2?RB[2]:[...RB[2],...RB[3]]).slice(0,10);}
const LB=[{image:'ğŸ¦·',badge:'ğŸ  Life Skills',bc:'#a84a10',text:'When should you brush your teeth?',answer:'Morning and night',dist:['Once a week','Only at night','Never']},{image:'ğŸ¤§',badge:'ğŸ  Life Skills',bc:'#a84a10',text:'You sneeze. What do you use?',answer:'A tissue',dist:['Your shirt','Your hands','A plate']},{image:'ğŸŒ§ï¸',badge:'ğŸ  Life Skills',bc:'#a84a10',text:"It's raining. What do you bring?",answer:'An umbrella',dist:['Sunglasses','Flip flops','A kite']},{image:'ğŸ½ï¸',badge:'ğŸ  Life Skills',bc:'#a84a10',text:'After dinner, what should you do?',answer:'Clear your plate',dist:['Leave everything','Jump on couch','Run outside']},{image:'ğŸš¦',badge:'ğŸ  Safety',bc:'#a84a10',text:'The traffic light is RED. You should:',answer:'STOP',dist:['GO fast','Turn around','Close eyes']},{image:'ğŸ¤',badge:'ğŸ  Social',bc:'#a84a10',text:'Someone helps you. You say:',answer:'Thank you',dist:['Go away','Whatever','I do not care']},{image:'ğŸ˜ ',badge:'ğŸ  Social',bc:'#a84a10',text:'You feel angry. A good thing to do:',answer:'Take deep breaths',dist:['Hit someone','Break things','Scream loud']},{image:'ğŸ§¼',badge:'ğŸ  Life Skills',bc:'#a84a10',text:'Before eating you should always:',answer:'Wash your hands',dist:['Watch TV','Run around','Read a book']},{image:'ğŸ“',badge:'ğŸ  Safety',bc:'#a84a10',text:'There is an emergency. You call:',answer:'911',dist:['411','211','811']}];
function lifeBank(){return sh(LB).slice(0,10);}
const SB=[{image:'ğŸ¦‹',badge:'ğŸ”¬ Science',bc:'#5c3db8',text:'A caterpillar grows into a:',answer:'Butterfly',dist:['Bee','Worm','Beetle']},{image:'ğŸŒ±',badge:'ğŸ”¬ Science',bc:'#5c3db8',text:'Plants need to grow:',answer:'Water and sunlight',dist:['Candy and soda','Only darkness','Music']},{image:'ğŸŒ',badge:'ğŸ”¬ Science',bc:'#5c3db8',text:'What shape is the Earth?',answer:'Round like a ball',dist:['Flat like paper','Square','Triangle']},{image:'ğŸŸ',badge:'ğŸ”¬ Science',bc:'#5c3db8',text:'Fish breathe using their:',answer:'Gills',dist:['Nose','Lungs','Ears']},{image:'â˜ï¸',badge:'ğŸ”¬ Science',bc:'#5c3db8',text:'Rain comes from:',answer:'Clouds',dist:['The sun','The ground','Mountains']},{image:'ğŸŒ™',badge:'ğŸ”¬ Science',bc:'#5c3db8',text:'The moon goes around:',answer:'The Earth',dist:['The sun','Mars','Other stars']},{image:'ğŸŒ¡ï¸',badge:'ğŸ”¬ Science',bc:'#5c3db8',text:'When very cold, water becomes:',answer:'Ice',dist:['Steam','Gas','Fire']},{image:'ğŸ»',badge:'ğŸ”¬ Science',bc:'#5c3db8',text:'Bears sleeping all winter is called:',answer:'Hibernation',dist:['Migration','Vacation','Camouflage']},{image:'ğŸ”­',badge:'ğŸ”¬ Science',bc:'#5c3db8',text:'The Earth goes around the:',answer:'Sun',dist:['Moon','Mars','Jupiter']},{image:'ğŸ«€',badge:'ğŸ”¬ Science',bc:'#5c3db8',text:'The heart pumps ___ around your body:',answer:'Blood',dist:['Air','Water','Food']}];
function scienceBank(){return sh(SB).slice(0,10);}

// STATE
let curSubj='math',curGrade=2,queue=[],qIdx=0,curQ=null,answered=false,roundOK=0,wrongQs=[],colorMap=[];

// SCREEN
function showScreen(name){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(name).classList.add('active');
  if(name==='progress') renderProgress();
  if(name==='home') badges();
  if(name==='settings') applySettings();
  if(name==='quiz'||name==='game') updateBreakButtons();
  // hide transition warning when leaving quiz
  if(name!=='quiz'){ const w=document.getElementById('transition-warn'); if(w) w.classList.remove('show'); }
}
function setGrade(g){curGrade=g;document.querySelectorAll('.grade-btn').forEach(b=>b.classList.remove('active'));document.getElementById('g'+g).classList.add('active');}

// START
function startSubject(subj){
  curSubj=subj;qIdx=0;roundOK=0;wrongQs=[];
  const m=SUBJ[subj];
  document.getElementById('quiz-subj').textContent=m.name;
  document.getElementById('quiz-subj').style.color=m.color;
  let rawQ;
  if(subj==='math') rawQ=mathBank(curGrade);
  else if(subj==='reading') rawQ=readingBank(curGrade);
  else if(subj==='life') rawQ=lifeBank();
  else rawQ=scienceBank();
  queue=rawQ.slice(0,CFG.qCount);
  showScreen('quiz');
  renderQ();
}
function newRound(){document.getElementById('cel').classList.remove('show');startSubject(curSubj);}

// RENDER
function renderQ(){
  curQ=queue[qIdx];answered=false;
  document.getElementById('prog-fill').style.width=Math.round(qIdx/queue.length*100)+'%';
  document.getElementById('prog-lbl').textContent=`Question ${qIdx+1} of ${queue.length}`;
  const img=curQ.image?`<div class="q-img">${curQ.image}</div>`:'';
  document.getElementById('q-box').innerHTML=`${img}<div class="q-text">${curQ.text}</div>`;
  const vals=sh([curQ.answer,...curQ.dist]).slice(0,4);
  while(vals.length<4)vals.push('?');
  const cols=sh([...COLORS]);
  colorMap=vals.map((val,i)=>({...cols[i],value:val,idx:i}));
  document.getElementById('ans-grid').innerHTML=colorMap.map(c=>`<button class="ans-btn ${c.id}" id="opt-${c.idx}" onclick="pick(${c.idx})"><div class="btn-bar"></div><div class="btn-num" id="num-${c.idx}">${c.value}</div></button>`).join('');

  // Adapt font size to text length so nothing wraps
  colorMap.forEach(c=>{
    const el=document.getElementById('num-'+c.idx);
    const len=c.value.length;
    if(len<=2)       el.style.fontSize='clamp(4rem,18vw,9rem)';
    else if(len<=4)  el.style.fontSize='clamp(2.8rem,12vw,6rem)';
    else if(len<=6)  el.style.fontSize='clamp(2rem,8vw,4rem)';
    else if(len<=10) el.style.fontSize='clamp(1.5rem,6vw,3rem)';
    else             el.style.fontSize='clamp(1.1rem,4vw,2rem)';
  });

  const fb=document.getElementById('feedback');fb.className='feedback';fb.innerHTML='';
  micSt('idle');
  document.getElementById('next-btn').style.display='none';
  checkTransitionWarn();
}

// ANSWER
function pick(idx){
  if(answered)return;
  answered=true;stopMic();
  const chosen=colorMap[idx];
  const ok=chosen.value===curQ.answer;
  const right=colorMap.find(c=>c.value===curQ.answer);
  document.getElementById('opt-'+right.idx).classList.add('correct');
  if(!ok)document.getElementById('opt-'+idx).classList.add('wrong');
  const fb=document.getElementById('feedback');
  if(ok){
    roundOK++;
    document.getElementById('quiz-stars').textContent=P.totalStars+roundOK;
    const phrase=CHEERS[Math.floor(Math.random()*CHEERS.length)];
    fb.className='feedback show good';
    fb.innerHTML=`<div>${phrase}</div>${curQ.eq?`<div class="eq">${curQ.eq}</div>`:''}`;
    setTimeout(()=>cheer(phrase),300);
  }else{
    wrongQs.push(curQ.text);
    fb.className='feedback show bad';
    fb.innerHTML=`<div>ğŸ’™ Good try! The answer is <strong>${curQ.answer}</strong></div>${curQ.eq?`<div class="eq">${curQ.eq}</div>`:''}`;
    setTimeout(()=>gentle(`Good try Shaan. The answer is ${curQ.answer}.`),300);
  }
  document.getElementById('next-btn').style.display='block';
  setTimeout(()=>{if(answered)nextQ();},ok?3800:5000);
}

function nextQ(){
  qIdx++;
  if(qIdx>=queue.length){
    logSess(curSubj,curGrade,queue.length,roundOK,wrongQs);
    document.getElementById('cel-msg').textContent=`You got ${roundOK} out of ${queue.length} right! â­ ${P.totalStars} total stars`;
    document.getElementById('cel').classList.add('show');
    setTimeout(()=>cheer(`Shaan you finished! You got ${roundOK} right! You are absolutely incredible and I am so proud of you!`),400);
  }else renderQ();
}

// PROGRESS SCREEN
function renderProgress(){
  const p=P;let sub='';
  ['math','reading','life','science'].forEach(s=>{const d=p.bySubject[s];const m=SUBJ[s];const pct=d&&d.attempts>0?Math.round(d.correct/d.attempts*100):null;sub+=`<div class="stat-row"><span class="stat-lbl">${m.name}</span>${pct!==null?`<div class="subj-bar"><div class="subj-fill" style="width:${pct}%;background:${m.color}"></div></div><span class="stat-val ${pct>=70?'green':''}">${pct}%</span>`:'<span class="stat-val" style="color:var(--muted)">Not yet</span>'}</div>`;});
  document.getElementById('prog-content').innerHTML=`<div class="stat-card"><h3>Overall</h3><div class="stat-row"><span class="stat-lbl">â­ Total Stars</span><span class="stat-val green">${p.totalStars}</span></div><div class="stat-row"><span class="stat-lbl">ğŸ”¥ Day Streak</span><span class="stat-val green">${p.streak}</span></div><div class="stat-row"><span class="stat-lbl">ğŸ“… Sessions</span><span class="stat-val">${p.sessions.length}</span></div></div><div class="stat-card"><h3>By Subject</h3>${sub}</div><button class="print-btn" onclick="printR()">ğŸ–¨ï¸ Print Teacher Report</button>`;
}

function printR(){
  const p=P;const today=new Date().toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
  let rows='';['math','reading','life','science'].forEach(s=>{const d=p.bySubject[s];const m=SUBJ[s];rows+=`<tr><td>${m.name}</td><td>${d?d.correct:0}</td><td>${d?d.attempts:0}</td><td><strong>${d&&d.attempts>0?Math.round(d.correct/d.attempts*100)+'%':'â€”'}</strong></td></tr>`;});
  const w=window.open('','_blank');
  w.document.write(`<!DOCTYPE html><html><head><title>ShaanSmart Report</title><style>body{font-family:Arial,sans-serif;padding:40px;max-width:700px;margin:0 auto}h1{color:#2a5fa8}table{width:100%;border-collapse:collapse;margin:16px 0}th,td{text-align:left;padding:10px 12px;border-bottom:1px solid #eee}th{background:#f0f4ff;color:#2a5fa8}@media print{button{display:none}}</style></head><body><h1>ğŸŒŸ ShaanSmart â€” Progress Report</h1><p><strong>Student:</strong> Shaan &nbsp; <strong>Date:</strong> ${today}</p><p>â­ Stars: <strong>${p.totalStars}</strong> &nbsp; ğŸ”¥ Streak: <strong>${p.streak} days</strong> &nbsp; Sessions: <strong>${p.sessions.length}</strong></p><table><thead><tr><th>Subject</th><th>Correct</th><th>Attempted</th><th>Accuracy</th></tr></thead><tbody>${rows}</tbody></table><p>Shaan answered by saying or pointing to a color-coded button. All responses are his own.</p><button onclick="window.print()">ğŸ–¨ï¸ Print</button></body></html>`);
  w.document.close();
}

// MIC
let recognition=null,micOn=false;
function setupMic(){
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;if(!SR)return;
  recognition=new SR();recognition.continuous=false;recognition.interimResults=true;recognition.lang='en-US';
  recognition.onstart=()=>{micOn=true;document.getElementById('mic-btn').classList.add('active');document.getElementById('mic-btn').textContent='ğŸ”´';micSt('listening');};
  recognition.onresult=e=>{let t='';for(let i=e.resultIndex;i<e.results.length;i++)t+=e.results[i][0].transcript;t=t.trim().toLowerCase();if(!curQ||answered)return;for(const c of colorMap){if(c.spoken.some(w=>t.includes(w))){micSt('heard',`Heard: ${c.id}`);stopMic();setTimeout(()=>pick(c.idx),380);return;}}if(t.length>0)micSt('listening',`"${t}"`);};
  recognition.onend=()=>{micOn=false;document.getElementById('mic-btn').classList.remove('active');document.getElementById('mic-btn').textContent='ğŸ¤';if(!answered)micSt('idle');};
  recognition.onerror=()=>{micOn=false;document.getElementById('mic-btn').classList.remove('active');document.getElementById('mic-btn').textContent='ğŸ¤';micSt('idle');};
}
function toggleMic(){if(!recognition){alert('Speech needs Safari iOS 15+ or Chrome.');return;}if(micOn)stopMic();else try{recognition.start();}catch(e){}}
function stopMic(){if(recognition&&micOn)try{recognition.stop();}catch(e){}}
function micSt(state,extra=''){const el=document.getElementById('mic-st');if(!el)return;if(state==='idle'){el.className='mic-st';el.textContent='';}else if(state==='listening'){el.className='mic-st listening';el.textContent='ğŸ”´ Listeningâ€¦'+(extra?' '+extra:'');}else if(state==='heard'){el.className='mic-st heard';el.textContent='âœ… '+extra;}}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GAME MODE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let gmSubj='math', gmTime=60;
let gmScore=0, gmTimer=null, gmTimeLeft=0, gmQ=null, gmAnswered=false, gmPool=[];

function gsPickSubj(subj, el){
  gmSubj=subj;
  document.querySelectorAll('.gs-subj-card').forEach(c=>c.classList.remove('sel'));
  el.classList.add('sel');
}
function gsPickTime(t, el){
  gmTime=t;
  document.querySelectorAll('.gs-btn').forEach(b=>b.classList.remove('active'));
  el.classList.add('active');
}

function buildGamePool(){
  let pool=[];
  if(gmSubj==='mix'){
    pool=[...mathBank(curGrade),...readingBank(curGrade),...lifeBank(),...scienceBank()];
  } else if(gmSubj==='math') pool=mathBank(curGrade);
  else if(gmSubj==='reading') pool=readingBank(curGrade);
  else if(gmSubj==='life') pool=lifeBank();
  else pool=scienceBank();
  return sh(pool);
}

function startGame(){
  gmScore=0; gmAnswered=false;
  gmPool=buildGamePool();
  let poolIdx=0;

  const meta={math:'ğŸ”¢ Math',reading:'ğŸ“– Reading',life:'ğŸ  Life',science:'ğŸ”¬ Science',mix:'ğŸŒŸ Mix'};
  const colors={math:'#2a5fa8',reading:'#1a7a4a',life:'#a84a10',science:'#5c3db8',mix:'#7a1a7a'};
  document.getElementById('game-subj').textContent=meta[gmSubj]||'Game';
  document.getElementById('game-subj').style.color=colors[gmSubj]||'#2a5fa8';
  document.getElementById('game-score').textContent='0';

  showScreen('game');

  // Timer
  gmTimeLeft=gmTime;
  const fill=document.getElementById('timer-fill');
  fill.style.transition='none';
  fill.style.width='100%';

  let lastTick=Date.now();
  clearInterval(gmTimer);
  gmTimer=setInterval(()=>{
    const now=Date.now();
    gmTimeLeft-=(now-lastTick)/1000;
    lastTick=now;
    const pct=Math.max(0,(gmTimeLeft/gmTime)*100);
    fill.style.transition='width .25s linear';
    fill.style.width=pct+'%';
    if(gmTimeLeft<=0){ clearInterval(gmTimer); endGame(); }
  },100);

  // Render first question
  function nextGameQ(){
    if(gmTimeLeft<=0) return;
    gmAnswered=false;
    if(poolIdx>=gmPool.length){ gmPool=sh(buildGamePool()); poolIdx=0; }
    gmQ=gmPool[poolIdx++];
    renderGameQ(gmQ, nextGameQ);
  }
  nextGameQ();
}

function renderGameQ(q, onNext){
  const img=q.image?`<div class="q-img">${q.image}</div>`:'';
  document.getElementById('game-q-box').innerHTML=`${img}<div class="q-text">${q.text}</div>`;

  const vals=sh([q.answer,...q.dist]).slice(0,4);
  while(vals.length<4) vals.push('?');
  const cols=sh([...COLORS]);
  const cmap=vals.map((val,i)=>({...cols[i],value:val,idx:i}));

  document.getElementById('game-ans-grid').innerHTML=cmap.map(c=>`
    <button class="ans-btn ${c.id}" id="gopt-${c.idx}" onclick="gamePick(${c.idx})">
      <div class="btn-bar"></div>
      <div class="btn-num" id="gnum-${c.idx}">${c.value}</div>
    </button>`).join('');

  cmap.forEach(c=>{
    const el=document.getElementById('gnum-'+c.idx);
    const len=c.value.length;
    if(len<=2)       el.style.fontSize='clamp(4rem,18vw,9rem)';
    else if(len<=4)  el.style.fontSize='clamp(2.8rem,12vw,6rem)';
    else if(len<=6)  el.style.fontSize='clamp(2rem,8vw,4rem)';
    else if(len<=10) el.style.fontSize='clamp(1.5rem,6vw,3rem)';
    else             el.style.fontSize='clamp(1.1rem,4vw,2rem)';
  });

  const fb=document.getElementById('game-feedback');
  fb.className='feedback'; fb.innerHTML='';
  gmAnswered=false;

  // Store colormap for gamePick
  window._gmCmap=cmap;
  window._gmOnNext=onNext;
}

function gamePick(idx){
  if(gmAnswered||gmTimeLeft<=0) return;
  gmAnswered=true;
  const cmap=window._gmCmap;
  const onNext=window._gmOnNext;
  const chosen=cmap[idx];
  const ok=chosen.value===gmQ.answer;
  const right=cmap.find(c=>c.value===gmQ.answer);

  document.getElementById('gopt-'+right.idx).classList.add('correct');
  if(!ok) document.getElementById('gopt-'+idx).classList.add('wrong');

  const flash=document.getElementById('score-flash');
  if(ok){
    gmScore=Math.max(0,gmScore+1);
    document.getElementById('game-score').textContent=gmScore;
    flash.textContent='+1';
    flash.className='score-flash plus';
    setTimeout(()=>flash.className='score-flash',700);
    const phrase=CHEERS[Math.floor(Math.random()*CHEERS.length)];
    setTimeout(()=>cheer(phrase),200);
  } else {
    gmScore=Math.max(0,gmScore-1);
    document.getElementById('game-score').textContent=gmScore;
    flash.textContent='-1';
    flash.className='score-flash minus';
    setTimeout(()=>flash.className='score-flash',700);
  }

  // Auto-advance â€” faster than regular mode
  setTimeout(()=>{ if(gmTimeLeft>0) onNext(); }, ok?1400:900);
}

function endGame(){
  clearInterval(gmTimer);
  stopMic();

  // Personal best
  if(!P.gameBests) P.gameBests={};
  const key=gmSubj;
  const prev=P.gameBests[key]||0;
  const isNew=gmScore>prev;
  if(isNew) P.gameBests[key]=gmScore;
  saveP();

  showScreen('game-end');

  const names={math:'Math',reading:'Reading',life:'Life Skills',science:'Science',mix:'All Subjects'};
  document.getElementById('ge-title').textContent=`${names[gmSubj]} â€” Time's up!`;
  document.getElementById('ge-score').textContent=gmScore;

  const bestEl=document.getElementById('ge-best');
  if(isNew && gmScore>0){
    bestEl.textContent='ğŸ† NEW PERSONAL BEST!';
    bestEl.className='ge-best new-record';
  } else {
    bestEl.textContent=`Personal best: ${Math.max(gmScore,prev)} points`;
    bestEl.className='ge-best';
  }

  const endMsg=gmScore===0
    ? `Shaan you tried so hard! Great effort! Let's play again!`
    : isNew
    ? `Shaan, NEW RECORD! You got ${gmScore} points! You are absolutely incredible! I am so proud of you!`
    : `Shaan, you got ${gmScore} points! You are amazing! Keep going â€” you can beat your best!`;

  setTimeout(()=>cheer(endMsg),500);
}

function stopGame(){
  clearInterval(gmTimer);
  gmTimeLeft=0;
  showScreen('game-setup');
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SETTINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let CFG = {
  voice: true,
  volume: 0.8,
  qCount: 10,
  breakOn: true,
  breakStyle: 'big',   // 'big' | 'small'
  calmDur: 60,
  gameTime: 60,
};

function loadCFG(){
  try { const s=localStorage.getItem('shaansmart_cfg'); if(s) CFG={...CFG,...JSON.parse(s)}; } catch(e){}
}
function saveCFG(){ try{localStorage.setItem('shaansmart_cfg',JSON.stringify(CFG));}catch(e){} }

function applySettings(){
  // voice toggle UI
  const tv=document.getElementById('tog-voice');
  if(tv) tv.className='set-toggle '+(CFG.voice?'on':'off');
  // volume slider
  const vs=document.getElementById('vol-slider');
  if(vs) vs.value=Math.round(CFG.volume*100);
  // q count
  document.querySelectorAll('#sq5,#sq10').forEach(b=>b.classList.remove('active'));
  const sqEl=document.getElementById('sq'+CFG.qCount);
  if(sqEl) sqEl.classList.add('active');
  // break toggle
  const tb=document.getElementById('tog-break');
  if(tb) tb.className='set-toggle '+(CFG.breakOn?'on':'off');
  // break style
  document.querySelectorAll('#bs-big,#bs-small').forEach(b=>b.classList.remove('active'));
  const bsEl=document.getElementById('bs-'+CFG.breakStyle);
  if(bsEl) bsEl.classList.add('active');
  // calm dur
  [30,60,90,120].forEach(d=>{
    const el=document.getElementById('cd'+d);
    if(el) el.classList.toggle('active', CFG.calmDur===d);
  });
  // game time
  [30,60,90,120].forEach(d=>{
    const el=document.getElementById('gt'+d);
    if(el) el.classList.toggle('active', CFG.gameTime===d);
  });
  // sync game mode default
  gmTime = CFG.gameTime;
  // sync game setup buttons
  document.querySelectorAll('.gs-btn').forEach(b=>{
    if(b.textContent===CFG.gameTime+'s' || b.textContent===(CFG.gameTime/60)+' min'
      || (CFG.gameTime===60&&b.textContent==='60 sec')
      || (CFG.gameTime===30&&b.textContent==='30 sec')
      || (CFG.gameTime===90&&b.textContent==='90 sec')
      || (CFG.gameTime===120&&b.textContent==='2 min')) {
      // handled by gsPickTime
    }
  });
}

function toggleSetting(key, btn){
  CFG[key] = !CFG[key];
  btn.className = 'set-toggle ' + (CFG[key]?'on':'off');
  saveCFG();
  updateBreakButtons();
}

function setVolume(val){
  CFG.volume = val/100;
  saveCFG();
}

function setQCount(n, btn){
  CFG.qCount = n;
  document.querySelectorAll('#sq5,#sq10').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  saveCFG();
}

function setBreakStyle(style, btn){
  CFG.breakStyle = style;
  document.querySelectorAll('#bs-big,#bs-small').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  saveCFG();
  updateBreakButtons();
}

function setCalmDur(d, btn){
  CFG.calmDur = d;
  [30,60,90,120].forEach(x=>{
    const el=document.getElementById('cd'+x);
    if(el) el.classList.toggle('active', x===d);
  });
  saveCFG();
}

function setGameTime(d, btn){
  CFG.gameTime = d;
  gmTime = d;
  [30,60,90,120].forEach(x=>{
    const el=document.getElementById('gt'+x);
    if(el) el.classList.toggle('active', x===d);
  });
  saveCFG();
}

function updateBreakButtons(){
  const big   = document.getElementById('break-btn-big');
  const small = document.getElementById('break-btn-small');
  if(!big||!small) return;
  const show = CFG.breakOn;
  const style = CFG.breakStyle;
  big.className   = 'break-btn-big'   + (show && style==='big'   ? ' show' : '');
  small.className = 'break-btn-small' + (show && style==='small' ? ' show' : '');
  // Also update game screen break buttons
  const gbig   = document.getElementById('game-break-btn-big');
  const gsmall = document.getElementById('game-break-btn-small');
  if(gbig)   gbig.className   = 'break-btn-big'   + (show && style==='big'   ? ' show' : '');
  if(gsmall) gsmall.className = 'break-btn-small' + (show && style==='small' ? ' show' : '');
}

// Override speak to respect volume/mute
const _origSpeak = speak;
function speak(txt, rate=0.82, pitch=1.22){
  if(!CFG.voice) return;
  if(!window.speechSynthesis||!txt) return;
  window.speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(txt);
  if(voice) u.voice = voice;
  u.rate = rate; u.pitch = pitch; u.volume = CFG.volume;
  window.speechSynthesis.speak(u);
}

let _muted = false;
function toggleMute(){
  _muted = !_muted;
  CFG.voice = !_muted;
  const btn = document.getElementById('mute-btn');
  if(btn) btn.textContent = _muted ? 'ğŸ”‡' : 'ğŸ”Š';
  if(_muted && window.speechSynthesis) window.speechSynthesis.cancel();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CALM BREAK SCREEN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let calmTimer = null;
let calmReturnScreen = 'quiz';
let calmAudio = null;

function buildCalmAudio(){
  try {
    const ctx = new (window.AudioContext||window.webkitAudioContext)();
    // Simple ambient tone: two sine waves slightly detuned for warmth
    const gain = ctx.createGain();
    gain.gain.setValueAtTime(0, ctx.currentTime);
    gain.gain.linearRampToValueAtTime(0.08, ctx.currentTime + 2);
    gain.connect(ctx.destination);

    function makeOsc(freq, detune=0){
      const o = ctx.createOscillator();
      o.type = 'sine';
      o.frequency.value = freq;
      o.detune.value = detune;
      const g = ctx.createGain();
      g.gain.value = 0.5;
      o.connect(g);
      g.connect(gain);
      o.start();
      return o;
    }

    // Gentle chord: A2, E3, A3 â€” calm and warm
    makeOsc(110);   // A2
    makeOsc(165, 3); // E3 slightly detuned
    makeOsc(220, -3); // A3 slightly detuned
    makeOsc(330, 5);  // E4

    // Slow LFO on gain for breathing feel
    const lfo = ctx.createOscillator();
    lfo.frequency.value = 0.12; // very slow ~7s cycle
    const lfoGain = ctx.createGain();
    lfoGain.gain.value = 0.04;
    lfo.connect(lfoGain);
    lfoGain.connect(gain.gain);
    lfo.start();

    calmAudio = { ctx, gain };
  } catch(e){ calmAudio = null; }
}

function stopCalmAudio(){
  if(calmAudio){
    try {
      calmAudio.gain.gain.linearRampToValueAtTime(0, calmAudio.ctx.currentTime + 1.5);
      setTimeout(()=>{ try{ calmAudio.ctx.close(); }catch(e){} calmAudio=null; }, 1600);
    } catch(e){ calmAudio=null; }
  }
}

function startCalm(){
  calmReturnScreen = document.querySelector('.screen.active')?.id || 'quiz';
  clearInterval(calmTimer);
  if(window.speechSynthesis) window.speechSynthesis.cancel();
  buildCalmAudio();

  const dur = CFG.calmDur;
  let left = dur;
  const fill = document.getElementById('calm-fill');
  const lbl  = document.getElementById('calm-lbl');
  if(fill) fill.style.width = '100%';
  if(lbl)  lbl.textContent = dur + ' seconds';

  showScreen('calm');

  calmTimer = setInterval(()=>{
    left--;
    const pct = Math.max(0, (left/dur)*100);
    if(fill) fill.style.transition = 'width 1s linear';
    if(fill) fill.style.width = pct + '%';
    if(lbl)  lbl.textContent = left > 0 ? left + ' seconds' : 'Ready when you are ğŸŒŸ';
    if(left <= 0){ clearInterval(calmTimer); }
  }, 1000);
}

function endCalm(){
  clearInterval(calmTimer);
  stopCalmAudio();
  showScreen(calmReturnScreen);
}

// Transition warning â€” show when 2 questions remain
function checkTransitionWarn(){
  const warn = document.getElementById('transition-warn');
  if(!warn) return;
  const remaining = queue.length - qIdx;
  warn.classList.toggle('show', remaining === 2);
}

// SW
if('serviceWorker' in navigator)window.addEventListener('load',()=>navigator.serviceWorker.register('./sw.js').catch(()=>{}));

// INIT
loadCFG();loadP();badges();setupMic();applySettings();
</script>
</body>
</html>
