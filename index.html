<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="ShaanSmart">
<meta name="theme-color" content="#2a5fa8">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icons/icon-192.png">
<title>ShaanSmart</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;800;900&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
:root{
  --bg:#eef1fb;--muted:#8890aa;
  --blue-bg:#ddeeff;--blue-mid:#5b9bd5;--blue-txt:#1a3d70;
  --green-bg:#d4f5e2;--green-mid:#3db87a;--green-deep:#1a7a4a;--green-txt:#0d4a2a;
  --purple-bg:#ece5ff;--purple-mid:#9b7fd4;--purple-txt:#32196e;
  --red-bg:#ffe5e5;--red-mid:#e85555;--red-deep:#a81a1a;--red-txt:#6e0d0d;
}
html,body{height:100%;overflow:hidden;font-family:'Nunito',sans-serif;color:#1a1a2e;user-select:none;-webkit-user-select:none;}

/* SCREENS ‚Äî each locks to full viewport */
.screen{position:fixed;top:0;left:0;right:0;bottom:0;display:none;flex-direction:column;overflow:hidden;background:var(--bg);}
.screen.active{display:flex;}

/* HOME */
#home{background:linear-gradient(160deg,#1e3a7a,#2a5fa8,#4a8fd8);overflow-y:auto;align-items:center;padding:env(safe-area-inset-top,16px) 20px env(safe-area-inset-bottom,16px);gap:0;}
.home-logo{font-size:3.5rem;margin-top:12px;animation:float 3s ease-in-out infinite;}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
.home-title{font-size:clamp(1.8rem,7vw,2.8rem);font-weight:900;color:white;margin-top:4px;}
.home-sub{font-size:.9rem;color:rgba(255,255,255,.7);font-weight:700;margin-top:2px;margin-bottom:14px;}
.stars-strip{background:rgba(255,255,255,.15);border-radius:40px;padding:7px 20px;color:white;font-weight:900;font-size:.9rem;margin-bottom:14px;display:flex;align-items:center;gap:8px;}
.sec-lbl{color:rgba(255,255,255,.7);font-size:.7rem;font-weight:800;text-transform:uppercase;letter-spacing:1px;align-self:flex-start;margin-bottom:6px;}
.grade-row{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px;align-self:flex-start;}
.grade-btn{background:rgba(255,255,255,.18);border:2px solid rgba(255,255,255,.35);border-radius:40px;padding:6px 16px;font-family:'Nunito',sans-serif;font-size:.8rem;font-weight:800;cursor:pointer;color:white;transition:all .15s;}
.grade-btn.active{background:white;color:#2a5fa8;border-color:white;}
.subject-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;width:100%;max-width:500px;margin-bottom:14px;}
.subject-card{border-radius:18px;padding:18px 12px 14px;display:flex;flex-direction:column;align-items:center;gap:5px;cursor:pointer;transition:transform .15s;box-shadow:0 6px 20px rgba(0,0,0,.2);border:2px solid rgba(255,255,255,.2);position:relative;}
.subject-card:active{transform:scale(.96);}
.subject-card.math{background:linear-gradient(135deg,#2a5fa8,#5b9bd5);}
.subject-card.read{background:linear-gradient(135deg,#1a7a4a,#3db87a);}
.subject-card.life{background:linear-gradient(135deg,#a84a10,#f07a3a);}
.subject-card.sci{background:linear-gradient(135deg,#5c3db8,#9b7fd4);}
.s-badge{position:absolute;top:8px;right:10px;background:rgba(255,255,255,.25);border-radius:20px;padding:2px 8px;font-size:.6rem;font-weight:900;color:white;}
.s-icon{font-size:2rem;}.s-name{font-size:.88rem;font-weight:900;color:white;}.s-count{font-size:.63rem;color:rgba(255,255,255,.75);font-weight:700;}
.nav-bar{display:flex;background:white;box-shadow:0 -2px 10px rgba(0,0,0,.08);flex-shrink:0;width:100%;padding-bottom:env(safe-area-inset-bottom,0px);}
.nav-item{flex:1;display:flex;flex-direction:column;align-items:center;padding:10px 4px 8px;cursor:pointer;border:none;background:none;font-family:'Nunito',sans-serif;gap:2px;}
.nav-icon{font-size:1.3rem;}.nav-label{font-size:.65rem;font-weight:800;color:var(--muted);}
.nav-item.active .nav-label{color:#2a5fa8;}

/* QUIZ ‚Äî strict column layout */
#quiz{background:var(--bg);}
.quiz-hdr{display:flex;align-items:center;gap:12px;padding:env(safe-area-inset-top,10px) 16px 10px;background:white;box-shadow:0 2px 8px rgba(0,0,0,.07);flex-shrink:0;}
.back-btn{background:none;border:none;font-size:1.4rem;cursor:pointer;padding:4px 8px;border-radius:8px;}
.quiz-subj{font-size:1rem;font-weight:900;}
.quiz-stars{margin-left:auto;font-size:.88rem;font-weight:800;color:#9a6e00;background:#fff9e0;border-radius:30px;padding:4px 12px;}
.prog-wrap{padding:6px 16px 4px;flex-shrink:0;}
.prog-lbl{font-size:.68rem;font-weight:800;color:var(--muted);margin-bottom:3px;}
.prog-bg{background:#dde3f5;border-radius:40px;height:8px;overflow:hidden;}
.prog-fill{height:100%;border-radius:40px;transition:width .5s ease;background:#5b9bd5;}

/* Question card ‚Äî no scroll, shrinks to content */
.q-box{margin:8px 14px 0;background:white;border-radius:18px;box-shadow:0 3px 12px rgba(0,0,0,.07);padding:12px 18px;text-align:center;flex-shrink:0;animation:fadeUp .25s ease;}
@keyframes fadeUp{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.q-badge{display:inline-block;border-radius:40px;padding:2px 10px;font-size:.6rem;font-weight:900;text-transform:uppercase;letter-spacing:1px;margin-bottom:4px;}
.q-img{font-size:2.2rem;margin-bottom:2px;}
.q-text{font-size:clamp(1.6rem,5.5vw,2.8rem);font-weight:900;line-height:1.2;}

/* Feedback ‚Äî hidden until answered */
.feedback{margin:5px 14px 0;border-radius:12px;padding:7px 14px;font-size:.88rem;font-weight:800;text-align:center;display:flex;flex-direction:column;align-items:center;gap:2px;flex-shrink:0;opacity:0;transition:opacity .3s;}
.feedback.show{opacity:1;}
.feedback.good{background:var(--green-bg);color:var(--green-deep);}
.feedback.bad{background:var(--red-bg);color:var(--red-deep);}
.eq{font-size:1rem;font-weight:900;}

/* Mic status ‚Äî invisible unless active */
.mic-st{margin:3px 14px 0;border-radius:8px;padding:4px 12px;font-size:.72rem;font-weight:800;text-align:center;flex-shrink:0;opacity:0;transition:opacity .2s;}
.mic-st.listening{opacity:1;background:var(--green-bg);color:var(--green-deep);animation:pulse 1s ease infinite;}
.mic-st.heard{opacity:1;background:#fff8d6;color:#7a5500;}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}

/* ANSWERS ‚Äî fills ALL remaining vertical space */
.ans-grid{display:grid;grid-template-columns:1fr 1fr;grid-template-rows:1fr 1fr;gap:16px;padding:10px 14px;flex:1;min-height:0;}

.ans-btn{border:5px solid transparent;border-radius:26px;cursor:pointer;display:flex;flex-direction:column;align-items:stretch;overflow:hidden;box-shadow:0 5px 18px rgba(0,0,0,.12);transition:transform .14s;}
.ans-btn:active{transform:scale(.96);}
.btn-bar{height:20px;flex-shrink:0;border-radius:20px 20px 0 0;}
.btn-num{flex:1;display:flex;align-items:center;justify-content:center;font-size:clamp(2rem,6.5vw,3.5rem);font-weight:900;line-height:1;padding:8px;word-break:break-word;text-align:center;}

.ans-btn.blue{background:var(--blue-bg);border-color:var(--blue-mid);}
.ans-btn.blue .btn-bar{background:var(--blue-mid);}
.ans-btn.blue .btn-num{color:var(--blue-txt);}
.ans-btn.green{background:var(--green-bg);border-color:var(--green-mid);}
.ans-btn.green .btn-bar{background:var(--green-mid);}
.ans-btn.green .btn-num{color:var(--green-txt);}
.ans-btn.purple{background:var(--purple-bg);border-color:var(--purple-mid);}
.ans-btn.purple .btn-bar{background:var(--purple-mid);}
.ans-btn.purple .btn-num{color:var(--purple-txt);}
.ans-btn.red{background:var(--red-bg);border-color:var(--red-mid);}
.ans-btn.red .btn-bar{background:var(--red-mid);}
.ans-btn.red .btn-num{color:var(--red-txt);}
.ans-btn.correct{box-shadow:0 0 0 7px var(--green-mid)!important;animation:pop .3s ease;}
.ans-btn.wrong{opacity:.3;}
@keyframes pop{0%{transform:scale(1)}45%{transform:scale(1.05)}100%{transform:scale(1)}}

.quiz-bottom{background:white;box-shadow:0 -2px 10px rgba(0,0,0,.07);padding:10px 20px calc(env(safe-area-inset-bottom,0px) + 10px);display:flex;align-items:center;justify-content:center;gap:20px;flex-shrink:0;}
.mic-btn{width:60px;height:60px;border-radius:50%;border:none;background:var(--blue-mid);color:white;font-size:1.5rem;cursor:pointer;box-shadow:0 4px 16px rgba(74,127,224,.4);transition:all .15s;}
.mic-btn.active{background:var(--green-mid);animation:pulse 1s ease infinite;}
.next-btn{background:#2a5fa8;color:white;border:none;border-radius:14px;padding:14px 30px;font-family:'Nunito',sans-serif;font-size:1rem;font-weight:900;cursor:pointer;display:none;}

/* PROGRESS */
#progress{background:var(--bg);}
.prog-hdr{background:white;padding:env(safe-area-inset-top,12px) 18px 12px;display:flex;align-items:center;gap:12px;box-shadow:0 2px 8px rgba(0,0,0,.06);flex-shrink:0;}
.prog-hdr h2{font-size:1.1rem;font-weight:900;}
.prog-content{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:14px;}
.stat-card{background:white;border-radius:18px;padding:16px 18px;box-shadow:0 3px 12px rgba(0,0,0,.07);}
.stat-card h3{font-size:.7rem;font-weight:900;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:10px;}
.stat-row{display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid #f0f0f0;}
.stat-row:last-child{border-bottom:none;}
.stat-lbl{font-size:.88rem;font-weight:700;}
.stat-val{font-size:.95rem;font-weight:900;}
.stat-val.green{color:var(--green-deep);}
.subj-bar{height:8px;border-radius:8px;background:#eee;overflow:hidden;flex:1;margin:0 10px;}
.subj-fill{height:100%;border-radius:8px;transition:width .6s ease;}
.print-btn{background:#2a5fa8;color:white;border:none;border-radius:14px;padding:14px;font-family:'Nunito',sans-serif;font-size:.95rem;font-weight:900;cursor:pointer;text-align:center;}

/* CELEBRATION */
.cel{position:fixed;inset:0;background:rgba(255,255,255,.97);display:none;flex-direction:column;align-items:center;justify-content:center;text-align:center;gap:14px;z-index:999;padding:32px;}
.cel.show{display:flex;animation:fadeUp .35s ease;}
.trophy{font-size:5rem;animation:bounce .7s ease infinite alternate;}
@keyframes bounce{from{transform:translateY(0)}to{transform:translateY(-12px)}}
.cel h1{font-size:clamp(1.6rem,6vw,2.2rem);font-weight:900;color:#2a5fa8;}
.cel p{font-size:1rem;color:var(--muted);font-weight:700;max-width:420px;}
.cel-btn{background:#2a5fa8;color:white;border:none;border-radius:16px;padding:14px 34px;font-family:'Nunito',sans-serif;font-size:1.05rem;font-weight:900;cursor:pointer;margin-top:4px;}
.cel-btn.outline{background:transparent;border:3px solid #2a5fa8;color:#2a5fa8;}
</style>
</head>
<body>

<!-- HOME -->
<div class="screen active" id="home">
  <div class="home-logo">üåü</div>
  <div class="home-title">ShaanSmart</div>
  <div class="home-sub">Shaan's Learning Adventure</div>
  <div class="stars-strip">‚≠ê <span id="home-stars">0</span> stars &nbsp;¬∑&nbsp; üî• <span id="home-streak">0</span> day streak</div>
  <div class="sec-lbl">Grade Level</div>
  <div class="grade-row">
    <button class="grade-btn active" onclick="setGrade(2)" id="g2">Grade 2</button>
    <button class="grade-btn" onclick="setGrade(3)" id="g3">Grade 3</button>
    <button class="grade-btn" onclick="setGrade(4)" id="g4">Grade 4</button>
    <button class="grade-btn" onclick="setGrade(5)" id="g5">Grade 5</button>
  </div>
  <div class="sec-lbl" style="margin-top:4px">Choose a Subject</div>
  <div class="subject-grid">
    <div class="subject-card math" onclick="startSubject('math')"><div class="s-badge" id="math-badge">‚Äî</div><div class="s-icon">üî¢</div><div class="s-name">Math</div><div class="s-count">Multiply ¬∑ Divide ¬∑ Fill-in</div></div>
    <div class="subject-card read" onclick="startSubject('reading')"><div class="s-badge" id="reading-badge">‚Äî</div><div class="s-icon">üìñ</div><div class="s-name">Reading</div><div class="s-count">Words ¬∑ Stories ¬∑ Rhymes</div></div>
    <div class="subject-card life" onclick="startSubject('life')"><div class="s-badge" id="life-badge">‚Äî</div><div class="s-icon">üè†</div><div class="s-name">Life Skills</div><div class="s-count">Daily ¬∑ Safety ¬∑ Social</div></div>
    <div class="subject-card sci" onclick="startSubject('science')"><div class="s-badge" id="science-badge">‚Äî</div><div class="s-icon">üî¨</div><div class="s-name">Science</div><div class="s-count">Nature ¬∑ Earth ¬∑ Animals</div></div>
  </div>
  <div class="nav-bar">
    <button class="nav-item active" onclick="showScreen('home')"><span class="nav-icon">üè†</span><span class="nav-label">Home</span></button>
    <button class="nav-item" onclick="showScreen('progress')"><span class="nav-icon">üìä</span><span class="nav-label">Progress</span></button>
  </div>
</div>

<!-- QUIZ -->
<div class="screen" id="quiz">
  <div class="quiz-hdr">
    <button class="back-btn" onclick="showScreen('home')">‚Üê</button>
    <span class="quiz-subj" id="quiz-subj">Math</span>
    <div class="quiz-stars">‚≠ê <span id="quiz-stars">0</span></div>
  </div>
  <div class="prog-wrap">
    <div class="prog-lbl" id="prog-lbl">Question 1 of 10</div>
    <div class="prog-bg"><div class="prog-fill" id="prog-fill" style="width:0%"></div></div>
  </div>
  <div class="q-box" id="q-box"></div>
  <div class="feedback" id="feedback"></div>
  <div class="mic-st" id="mic-st"></div>
  <div class="ans-grid" id="ans-grid"></div>
  <div class="quiz-bottom">
    <button class="mic-btn" id="mic-btn" onclick="toggleMic()">üé§</button>
    <button class="next-btn" id="next-btn" onclick="nextQ()">Next ‚û°Ô∏è</button>
  </div>
</div>

<!-- PROGRESS -->
<div class="screen" id="progress">
  <div class="prog-hdr">
    <button class="back-btn" onclick="showScreen('home')">‚Üê</button>
    <h2>Shaan's Progress</h2>
  </div>
  <div class="prog-content" id="prog-content"></div>
  <div class="nav-bar">
    <button class="nav-item" onclick="showScreen('home')"><span class="nav-icon">üè†</span><span class="nav-label">Home</span></button>
    <button class="nav-item active" onclick="showScreen('progress')"><span class="nav-icon">üìä</span><span class="nav-label">Progress</span></button>
  </div>
</div>

<!-- CELEBRATION -->
<div class="cel" id="cel">
  <div class="trophy">üèÜ</div>
  <h1>Shaan, you are AMAZING!</h1>
  <p id="cel-msg"></p>
  <div style="font-size:2rem">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</div>
  <button class="cel-btn" onclick="newRound()">Keep Going! üöÄ</button>
  <button class="cel-btn outline" onclick="showScreen('home')" style="margin-top:6px">Back to Home</button>
</div>

<script>
const COLORS=[{id:'blue',spoken:['blue']},{id:'green',spoken:['green']},{id:'purple',spoken:['purple']},{id:'red',spoken:['red']}];
const CHEERS=["Shaan, you are absolutely amazing! I knew you could do it!","Yes! Shaan got it right! You are SO smart!","Wow Shaan! That is exactly right! You should be so proud!","Shaan, you are a superstar! Keep going!","Oh my goodness Shaan! Perfect answer! You are incredible!","That's right Shaan! You are brilliant! I am so proud of you!","Shaan, you did it again! You are totally on fire today!","Amazing Shaan! You are seriously so clever! Great job!","Yes yes yes! Shaan is unstoppable! What an absolute superstar!"];
const SUBJ={math:{name:'üî¢ Math',color:'#2a5fa8'},reading:{name:'üìñ Reading',color:'#1a7a4a'},life:{name:'üè† Life',color:'#a84a10'},science:{name:'üî¨ Science',color:'#5c3db8'}};

// VOICE
let voice=null;
function loadVoice(){const vs=window.speechSynthesis?.getVoices()||[];if(!vs.length)return;const tests=[v=>v.name==='Samantha',v=>v.name==='Karen',v=>v.name==='Tessa',v=>/Zira/i.test(v.name),v=>/Jenny/i.test(v.name)&&v.lang.startsWith('en'),v=>/Aria/i.test(v.name)&&v.lang.startsWith('en'),v=>v.lang==='en-AU',v=>v.lang==='en-US'];for(const t of tests){const m=vs.find(t);if(m){voice=m;break;}}}
if(window.speechSynthesis){window.speechSynthesis.onvoiceschanged=loadVoice;loadVoice();}
function speak(txt,rate=0.82,pitch=1.22){if(!window.speechSynthesis||!txt)return;window.speechSynthesis.cancel();const u=new SpeechSynthesisUtterance(txt);if(voice)u.voice=voice;u.rate=rate;u.pitch=pitch;u.volume=1;window.speechSynthesis.speak(u);}
const cheer=t=>speak(t,.79,1.32);
const gentle=t=>speak(t,.80,1.10);

// PROGRESS
const KEY='shaansmart_v1';let P={};
function loadP(){try{P=JSON.parse(localStorage.getItem(KEY)||'{}');}catch(e){P={};}P.totalStars=P.totalStars||0;P.sessions=P.sessions||[];P.bySubject=P.bySubject||{};P.streak=P.streak||0;P.lastDate=P.lastDate||null;}
function saveP(){try{localStorage.setItem(KEY,JSON.stringify(P));}catch(e){}}
function logSess(subj,grade,total,correct,wrongs){
  const today=new Date().toISOString().split('T')[0];
  if(P.lastDate!==today){const yd=new Date();yd.setDate(yd.getDate()-1);P.streak=P.lastDate===yd.toISOString().split('T')[0]?P.streak+1:1;P.lastDate=today;}
  P.totalStars+=correct;
  if(!P.bySubject[subj])P.bySubject[subj]={attempts:0,correct:0,wrong:[]};
  const s=P.bySubject[subj];s.attempts+=total;s.correct+=correct;s.wrong=[...(s.wrong||[]),...wrongs].slice(-30);
  P.sessions=[...P.sessions,{date:today,subj,grade,total,correct}].slice(-100);
  saveP();badges();
}
function badges(){
  document.getElementById('home-stars').textContent=P.totalStars||0;
  document.getElementById('home-streak').textContent=P.streak||0;
  document.getElementById('quiz-stars').textContent=P.totalStars||0;
  ['math','reading','life','science'].forEach(s=>{const d=P.bySubject[s];const el=document.getElementById(s+'-badge');if(el&&d&&d.attempts>0)el.textContent=Math.round(d.correct/d.attempts*100)+'%';});
}

// QUESTION BANKS
const sh=arr=>{const a=[...arr];for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;};
function gD(ans,a,b){const s=new Set([ans+1,ans-1,a+b,ans+b,ans-a,ans+3]);return[...s].filter(x=>x>0&&x!==ans).sort(()=>Math.random()-.5).slice(0,3).map(String);}
const M={2:[[2,2],[2,3],[2,4],[2,5],[3,3],[3,4],[4,2],[5,2]],3:[[2,6],[2,7],[2,8],[2,9],[3,5],[3,6],[4,4],[4,5],[5,5]],4:[[3,7],[3,8],[4,6],[4,7],[5,6],[5,7],[6,6],[7,3]],5:[[4,8],[5,8],[5,9],[6,7],[6,8],[7,7],[7,8],[8,8],[9,6],[12,7]]};
const D={2:[[4,2],[6,2],[6,3],[8,2],[8,4],[9,3]],3:[[12,3],[12,4],[15,3],[16,4],[18,6],[20,4]],4:[[24,6],[24,8],[28,4],[32,8],[36,9],[42,7]],5:[[48,6],[56,7],[63,9],[72,8],[81,9],[84,7]]};
function mathBank(grade){const g=Math.min(Math.max(grade,2),5);const mp=M[g]||M[3];const dp=D[g]||D[3];const qs=[];sh(mp).slice(0,4).forEach(([a,b])=>{const ans=a*b;qs.push({badge:'‚úñÔ∏è Multiply',bc:'#2a5fa8',text:`${a} √ó ${b} = ?`,eq:`${a} √ó ${b} = ${ans}`,answer:String(ans),dist:gD(ans,a,b)});});sh(dp).slice(0,3).forEach(([a,b])=>{const p=a*b;qs.push({badge:'‚ûó Divide',bc:'#1a7a4a',text:`${p} √∑ ${b} = ?`,eq:`${p} √∑ ${b} = ${a}`,answer:String(a),dist:gD(a,p,b)});});sh(mp).slice(0,3).forEach(([a,b])=>{const ans=a*b;const slot=Math.random()<.5?'first':'second';const cor=slot==='first'?String(a):String(b);qs.push({badge:'üî≤ Fill in',bc:'#5c3db8',text:slot==='first'?`___ √ó ${b} = ${ans}`:`${a} √ó ___ = ${ans}`,eq:`${a} √ó ${b} = ${ans}`,answer:cor,dist:gD(Number(cor),a,b)});});return sh(qs).slice(0,10);}
const RB={2:[{image:'üê±',badge:'üìñ Words',bc:'#1a7a4a',text:'What word matches this picture?',answer:'CAT',dist:['DOG','RAT','BAT']},{image:'‚òÄÔ∏è',badge:'üìñ Reading',bc:'#1a7a4a',text:'Which word describes the sun?',answer:'HOT',dist:['WET','COLD','DARK']},{image:'üè†',badge:'üìñ Rhymes',bc:'#1a7a4a',text:'Which word rhymes with HOUSE?',answer:'MOUSE',dist:['TREE','BOOK','CAKE']},{image:'üê∂',badge:'üìñ Reading',bc:'#1a7a4a',text:'The dog ran fast. What did the dog do?',answer:'RAN',dist:['ATE','SLEPT','SWAM']},{image:'üåßÔ∏è',badge:'üìñ Words',bc:'#1a7a4a',text:'What is falling from the sky?',answer:'RAIN',dist:['SNOW','HAIL','LEAVES']},{image:'üéÇ',badge:'üìñ Rhymes',bc:'#1a7a4a',text:'Which word rhymes with CAKE?',answer:'LAKE',dist:['FISH','TREE','BALL']},{image:'üå≥',badge:'üìñ Words',bc:'#1a7a4a',text:'Leaves grow on a ___.',answer:'TREE',dist:['HOUSE','CAR','BOOK']}],3:[{image:'ü¶ã',badge:'üìñ Reading',bc:'#1a7a4a',text:'"The butterfly was beautiful." Beautiful means:',answer:'Pretty to look at',dist:['Very loud','Smells bad','Really fast']},{image:'üåä',badge:'üìñ Words',bc:'#1a7a4a',text:'A large body of water is called:',answer:'OCEAN',dist:['RIVER','POND','PUDDLE']},{image:'üêò',badge:'üìñ Reading',bc:'#1a7a4a',text:'"Elephants are enormous." Enormous means:',answer:'Very big',dist:['Very fast','Very loud','Very soft']},{image:'üî•',badge:'üìñ Rhymes',bc:'#1a7a4a',text:'Which word rhymes with HEAT?',answer:'BEAT',dist:['COOL','BURN','WAVE']},{image:'üèÜ',badge:'üìñ Words',bc:'#1a7a4a',text:'First place winner is called a:',answer:'CHAMPION',dist:['PLAYER','TEAM','COACH']}]};
function readingBank(g){return sh(g<=2?RB[2]:[...RB[2],...RB[3]]).slice(0,10);}
const LB=[{image:'ü¶∑',badge:'üè† Life Skills',bc:'#a84a10',text:'When should you brush your teeth?',answer:'Morning and night',dist:['Once a week','Only at night','Never']},{image:'ü§ß',badge:'üè† Life Skills',bc:'#a84a10',text:'You sneeze. What do you use?',answer:'A tissue',dist:['Your shirt','Your hands','A plate']},{image:'üåßÔ∏è',badge:'üè† Life Skills',bc:'#a84a10',text:"It's raining. What do you bring?",answer:'An umbrella',dist:['Sunglasses','Flip flops','A kite']},{image:'üçΩÔ∏è',badge:'üè† Life Skills',bc:'#a84a10',text:'After dinner, what should you do?',answer:'Clear your plate',dist:['Leave everything','Jump on couch','Run outside']},{image:'üö¶',badge:'üè† Safety',bc:'#a84a10',text:'The traffic light is RED. You should:',answer:'STOP',dist:['GO fast','Turn around','Close eyes']},{image:'ü§ù',badge:'üè† Social',bc:'#a84a10',text:'Someone helps you. You say:',answer:'Thank you',dist:['Go away','Whatever','I do not care']},{image:'üò†',badge:'üè† Social',bc:'#a84a10',text:'You feel angry. A good thing to do:',answer:'Take deep breaths',dist:['Hit someone','Break things','Scream loud']},{image:'üßº',badge:'üè† Life Skills',bc:'#a84a10',text:'Before eating you should always:',answer:'Wash your hands',dist:['Watch TV','Run around','Read a book']},{image:'üìû',badge:'üè† Safety',bc:'#a84a10',text:'There is an emergency. You call:',answer:'911',dist:['411','211','811']}];
function lifeBank(){return sh(LB).slice(0,10);}
const SB=[{image:'ü¶ã',badge:'üî¨ Science',bc:'#5c3db8',text:'A caterpillar grows into a:',answer:'Butterfly',dist:['Bee','Worm','Beetle']},{image:'üå±',badge:'üî¨ Science',bc:'#5c3db8',text:'Plants need to grow:',answer:'Water and sunlight',dist:['Candy and soda','Only darkness','Music']},{image:'üåç',badge:'üî¨ Science',bc:'#5c3db8',text:'What shape is the Earth?',answer:'Round like a ball',dist:['Flat like paper','Square','Triangle']},{image:'üêü',badge:'üî¨ Science',bc:'#5c3db8',text:'Fish breathe using their:',answer:'Gills',dist:['Nose','Lungs','Ears']},{image:'‚òÅÔ∏è',badge:'üî¨ Science',bc:'#5c3db8',text:'Rain comes from:',answer:'Clouds',dist:['The sun','The ground','Mountains']},{image:'üåô',badge:'üî¨ Science',bc:'#5c3db8',text:'The moon goes around:',answer:'The Earth',dist:['The sun','Mars','Other stars']},{image:'üå°Ô∏è',badge:'üî¨ Science',bc:'#5c3db8',text:'When very cold, water becomes:',answer:'Ice',dist:['Steam','Gas','Fire']},{image:'üêª',badge:'üî¨ Science',bc:'#5c3db8',text:'Bears sleeping all winter is called:',answer:'Hibernation',dist:['Migration','Vacation','Camouflage']},{image:'üî≠',badge:'üî¨ Science',bc:'#5c3db8',text:'The Earth goes around the:',answer:'Sun',dist:['Moon','Mars','Jupiter']},{image:'ü´Ä',badge:'üî¨ Science',bc:'#5c3db8',text:'The heart pumps ___ around your body:',answer:'Blood',dist:['Air','Water','Food']}];
function scienceBank(){return sh(SB).slice(0,10);}

// STATE
let curSubj='math',curGrade=2,queue=[],qIdx=0,curQ=null,answered=false,roundOK=0,wrongQs=[],colorMap=[];

// SCREEN
function showScreen(name){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));document.getElementById(name).classList.add('active');if(name==='progress')renderProgress();if(name==='home')badges();}
function setGrade(g){curGrade=g;document.querySelectorAll('.grade-btn').forEach(b=>b.classList.remove('active'));document.getElementById('g'+g).classList.add('active');}

// START
function startSubject(subj){
  curSubj=subj;qIdx=0;roundOK=0;wrongQs=[];
  const m=SUBJ[subj];
  document.getElementById('quiz-subj').textContent=m.name;
  document.getElementById('quiz-subj').style.color=m.color;
  if(subj==='math') queue=mathBank(curGrade);
  else if(subj==='reading') queue=readingBank(curGrade);
  else if(subj==='life') queue=lifeBank();
  else queue=scienceBank();
  showScreen('quiz');
  renderQ();
}
function newRound(){document.getElementById('cel').classList.remove('show');startSubject(curSubj);}

// RENDER
function renderQ(){
  curQ=queue[qIdx];answered=false;
  document.getElementById('prog-fill').style.width=Math.round(qIdx/queue.length*100)+'%';
  document.getElementById('prog-lbl').textContent=`Question ${qIdx+1} of ${queue.length}`;
  const img=curQ.image?`<div class="q-img">${curQ.image}</div>`:'';
  document.getElementById('q-box').innerHTML=`<div class="q-badge" style="background:${curQ.bc}18;color:${curQ.bc}">${curQ.badge}</div>${img}<div class="q-text">${curQ.text}</div>`;
  const vals=sh([curQ.answer,...curQ.dist]).slice(0,4);
  while(vals.length<4)vals.push('?');
  const cols=sh([...COLORS]);
  colorMap=vals.map((val,i)=>({...cols[i],value:val,idx:i}));
  document.getElementById('ans-grid').innerHTML=colorMap.map(c=>`<button class="ans-btn ${c.id}" id="opt-${c.idx}" onclick="pick(${c.idx})"><div class="btn-bar"></div><div class="btn-num">${c.value}</div></button>`).join('');
  const fb=document.getElementById('feedback');fb.className='feedback';fb.innerHTML='';
  micSt('idle');
  document.getElementById('next-btn').style.display='none';
}

// ANSWER
function pick(idx){
  if(answered)return;
  answered=true;stopMic();
  const chosen=colorMap[idx];
  const ok=chosen.value===curQ.answer;
  const right=colorMap.find(c=>c.value===curQ.answer);
  document.getElementById('opt-'+right.idx).classList.add('correct');
  if(!ok)document.getElementById('opt-'+idx).classList.add('wrong');
  const fb=document.getElementById('feedback');
  if(ok){
    roundOK++;
    document.getElementById('quiz-stars').textContent=P.totalStars+roundOK;
    const phrase=CHEERS[Math.floor(Math.random()*CHEERS.length)];
    fb.className='feedback show good';
    fb.innerHTML=`<div>${phrase}</div>${curQ.eq?`<div class="eq">${curQ.eq}</div>`:''}`;
    setTimeout(()=>cheer(phrase),300);
  }else{
    wrongQs.push(curQ.text);
    fb.className='feedback show bad';
    fb.innerHTML=`<div>üíô Good try! The answer is <strong>${curQ.answer}</strong></div>${curQ.eq?`<div class="eq">${curQ.eq}</div>`:''}`;
    setTimeout(()=>gentle(`Good try Shaan. The answer is ${curQ.answer}.`),300);
  }
  document.getElementById('next-btn').style.display='block';
  setTimeout(()=>{if(answered)nextQ();},ok?3800:5000);
}

function nextQ(){
  qIdx++;
  if(qIdx>=queue.length){
    logSess(curSubj,curGrade,queue.length,roundOK,wrongQs);
    document.getElementById('cel-msg').textContent=`You got ${roundOK} out of ${queue.length} right! ‚≠ê ${P.totalStars} total stars`;
    document.getElementById('cel').classList.add('show');
    setTimeout(()=>cheer(`Shaan you finished! You got ${roundOK} right! You are absolutely incredible and I am so proud of you!`),400);
  }else renderQ();
}

// PROGRESS SCREEN
function renderProgress(){
  const p=P;let sub='';
  ['math','reading','life','science'].forEach(s=>{const d=p.bySubject[s];const m=SUBJ[s];const pct=d&&d.attempts>0?Math.round(d.correct/d.attempts*100):null;sub+=`<div class="stat-row"><span class="stat-lbl">${m.name}</span>${pct!==null?`<div class="subj-bar"><div class="subj-fill" style="width:${pct}%;background:${m.color}"></div></div><span class="stat-val ${pct>=70?'green':''}">${pct}%</span>`:'<span class="stat-val" style="color:var(--muted)">Not yet</span>'}</div>`;});
  document.getElementById('prog-content').innerHTML=`<div class="stat-card"><h3>Overall</h3><div class="stat-row"><span class="stat-lbl">‚≠ê Total Stars</span><span class="stat-val green">${p.totalStars}</span></div><div class="stat-row"><span class="stat-lbl">üî• Day Streak</span><span class="stat-val green">${p.streak}</span></div><div class="stat-row"><span class="stat-lbl">üìÖ Sessions</span><span class="stat-val">${p.sessions.length}</span></div></div><div class="stat-card"><h3>By Subject</h3>${sub}</div><button class="print-btn" onclick="printR()">üñ®Ô∏è Print Teacher Report</button>`;
}

function printR(){
  const p=P;const today=new Date().toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
  let rows='';['math','reading','life','science'].forEach(s=>{const d=p.bySubject[s];const m=SUBJ[s];rows+=`<tr><td>${m.name}</td><td>${d?d.correct:0}</td><td>${d?d.attempts:0}</td><td><strong>${d&&d.attempts>0?Math.round(d.correct/d.attempts*100)+'%':'‚Äî'}</strong></td></tr>`;});
  const w=window.open('','_blank');
  w.document.write(`<!DOCTYPE html><html><head><title>ShaanSmart Report</title><style>body{font-family:Arial,sans-serif;padding:40px;max-width:700px;margin:0 auto}h1{color:#2a5fa8}table{width:100%;border-collapse:collapse;margin:16px 0}th,td{text-align:left;padding:10px 12px;border-bottom:1px solid #eee}th{background:#f0f4ff;color:#2a5fa8}@media print{button{display:none}}</style></head><body><h1>üåü ShaanSmart ‚Äî Progress Report</h1><p><strong>Student:</strong> Shaan &nbsp; <strong>Date:</strong> ${today}</p><p>‚≠ê Stars: <strong>${p.totalStars}</strong> &nbsp; üî• Streak: <strong>${p.streak} days</strong> &nbsp; Sessions: <strong>${p.sessions.length}</strong></p><table><thead><tr><th>Subject</th><th>Correct</th><th>Attempted</th><th>Accuracy</th></tr></thead><tbody>${rows}</tbody></table><p>Shaan answered by saying or pointing to a color-coded button. All responses are his own.</p><button onclick="window.print()">üñ®Ô∏è Print</button></body></html>`);
  w.document.close();
}

// MIC
let recognition=null,micOn=false;
function setupMic(){
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;if(!SR)return;
  recognition=new SR();recognition.continuous=false;recognition.interimResults=true;recognition.lang='en-US';
  recognition.onstart=()=>{micOn=true;document.getElementById('mic-btn').classList.add('active');document.getElementById('mic-btn').textContent='üî¥';micSt('listening');};
  recognition.onresult=e=>{let t='';for(let i=e.resultIndex;i<e.results.length;i++)t+=e.results[i][0].transcript;t=t.trim().toLowerCase();if(!curQ||answered)return;for(const c of colorMap){if(c.spoken.some(w=>t.includes(w))){micSt('heard',`Heard: ${c.id}`);stopMic();setTimeout(()=>pick(c.idx),380);return;}}if(t.length>0)micSt('listening',`"${t}"`);};
  recognition.onend=()=>{micOn=false;document.getElementById('mic-btn').classList.remove('active');document.getElementById('mic-btn').textContent='üé§';if(!answered)micSt('idle');};
  recognition.onerror=()=>{micOn=false;document.getElementById('mic-btn').classList.remove('active');document.getElementById('mic-btn').textContent='üé§';micSt('idle');};
}
function toggleMic(){if(!recognition){alert('Speech needs Safari iOS 15+ or Chrome.');return;}if(micOn)stopMic();else try{recognition.start();}catch(e){}}
function stopMic(){if(recognition&&micOn)try{recognition.stop();}catch(e){}}
function micSt(state,extra=''){const el=document.getElementById('mic-st');if(!el)return;if(state==='idle'){el.className='mic-st';el.textContent='';}else if(state==='listening'){el.className='mic-st listening';el.textContent='üî¥ Listening‚Ä¶'+(extra?' '+extra:'');}else if(state==='heard'){el.className='mic-st heard';el.textContent='‚úÖ '+extra;}}

// SW
if('serviceWorker' in navigator)window.addEventListener('load',()=>navigator.serviceWorker.register('./sw.js').catch(()=>{}));

// INIT
loadP();badges();setupMic();
</script>
</body>
</html>
